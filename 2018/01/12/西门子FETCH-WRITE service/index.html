<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0 在pvbrowser里设置与PLC连接的时候有一项fetch_write，下面具体看一下这一项 ##rlSiemensTcp源码 446   if((plc_type == S5 || plc_type == S7_300 || plc_type =">
<meta property="og:type" content="article">
<meta property="og:title" content="JMJ">
<meta property="og:url" content="http://yoursite.com/2018/01/12/西门子FETCH-WRITE service/index.html">
<meta property="og:site_name" content="JMJ">
<meta property="og:description" content="slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0 在pvbrowser里设置与PLC连接的时候有一项fetch_write，下面具体看一下这一项 ##rlSiemensTcp源码 446   if((plc_type == S5 || plc_type == S7_300 || plc_type =">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://oxehqp0gf.bkt.clouddn.com/WH.PNG">
<meta property="og:image" content="http://oxehqp0gf.bkt.clouddn.com/WA.PNG">
<meta property="og:image" content="http://oxehqp0gf.bkt.clouddn.com/FH.PNG">
<meta property="og:image" content="http://oxehqp0gf.bkt.clouddn.com/FA.PNG">
<meta property="og:image" content="http://oxehqp0gf.bkt.clouddn.com/FetchWrite%20ISO.PNG">
<meta property="og:image" content="http://oxehqp0gf.bkt.clouddn.com/FW%20Message%20structure.PNG">
<meta property="og:updated_time" content="2018-01-12T12:17:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JMJ">
<meta name="twitter:description" content="slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0 在pvbrowser里设置与PLC连接的时候有一项fetch_write，下面具体看一下这一项 ##rlSiemensTcp源码 446   if((plc_type == S5 || plc_type == S7_300 || plc_type =">
<meta name="twitter:image" content="http://oxehqp0gf.bkt.clouddn.com/WH.PNG">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/12/西门子FETCH-WRITE service/"/>





  <title> | JMJ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JMJ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/西门子FETCH-WRITE service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline"></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工控-pvbrowser/" itemprop="url" rel="index">
                    <span itemprop="name">工控 pvbrowser</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <pre><code>slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0
</code></pre><p>在pvbrowser里设置与PLC连接的时候有一项fetch_write，下面具体看一下这一项</p>
<p>##rlSiemensTcp源码</p>
<pre><code>446   if((plc_type == S5 || plc_type == S7_300 || plc_type == S7_400) &amp;&amp; fetch_write == 1)
 447   {
 448     length = sizeof(ih) + sizeof(fh);
 449     ih.version  = 3;
 450     ih.reserved = 0;
 451     ih.length_high = length / 256;
 452     ih.length_low  = length &amp; 0x0ff;
 453     fh.ident[0]        = &apos;S&apos;;
 454     fh.ident[1]        = &apos;5&apos;;
 455     fh.header_len      = 16;
 456     fh.ident_op_code   = 1;
 457     fh.op_code_len     = 3;
 458     fh.op_code         = 5;
 459     fh.ident_org_block = 3;
 460     fh.len_org_block   = 8;
 461     fh.org_block       = (unsigned char) org;
 462     fh.dbnr            = (unsigned char) dbnr;
 463     fh.start_adr[0]    = (unsigned char) start_adr / 256;
 464     fh.start_adr[1]    = (unsigned char) start_adr &amp; 0x0ff;;
 465     fh.len[0]          = (unsigned char) len / 256;
 466     fh.len[1]          = (unsigned char) len &amp; 0x0ff;;
 467     fh.spare1          = 0x0ff;
 468     fh.spare1_len      = 2;
 469     unsigned char total_buf[sizeof(ih)+sizeof(fh)];
 470     memcpy(total_buf,             &amp;ih, sizeof(ih));
 471     memcpy(total_buf+sizeof(ih),  &amp;fh, sizeof(fh));
 472     ret = rlSocket::write(total_buf,   sizeof(ih)+sizeof(fh));
 473     rlDebugPrintf(&quot;fetch write ih ret=%d\n&quot;,ret);
 474     if(ret &lt; 0) return ret;  
 475     /*
 476     ret = rlSocket::write(&amp;ih,sizeof(ih));
 477     rlDebugPrintf(&quot;fetch write ih ret=%d\n&quot;,ret);
 478     if(ret &lt; 0) return ret;  
 479     ret = rlSocket::write(&amp;fh,sizeof(fh));
 480     rlDebugPrintf(&quot;fetch write fh ret=%d\n&quot;,ret);
 481     if(ret &lt; 0) return ret;
 482     */
 483     ret = rlSocket::read(&amp;ih,sizeof(ih),TIMEOUT);
 484     rlDebugPrintf(&quot;fetch read ih ret=%d\n&quot;,ret);
 485     if(ret &lt;= 0) return ret;
 486     ret = rlSocket::read(&amp;fa,sizeof(fa),TIMEOUT);
 487     rlDebugPrintf(&quot;fetch read fa ret=%d\n&quot;,ret);
 488     if(ret &lt;= 0) return ret;
 489     if(fa.error_block != 0) return -1;
 490     ret = rlSocket::read(buf,len_byte,TIMEOUT);
 491     rlDebugPrintf(&quot;fetch read buf ret=%d\n&quot;,ret);
 492     if(ret &lt;= 0) return ret;
 493   }
</code></pre><p>###判断PLC系列</p>
<pre><code>if((plc_type == S5 || plc_type == S7_300 || plc_type == S7_400) &amp;&amp; fetch_write == 1)
</code></pre><p>首先判断PLC是不是S5，300和400系列。Fetch/Write只支持这些系列，对于像1200，200smart这些是不支持的。<br>并且，在300和400系列中，对于CP343-1，CP443-1是支持Fetch/Write的，对于内嵌Ethernet的CPU需要配置一下。如何配置请查看西门子官方文档《FETCH/WRITE service in an S7-300/400 CPU via the integrated Ethernet interface》.<br>如果不是这些系列的PLC或者fetch_write=0时，则是S7通讯.</p>
<blockquote>
<p>In today’s automation technology old systems are upgraded step by step from SIMATIC S5 to SIMATIC S7. However, the interfaces for the data exchange on the peer (for example, existing HMI systems) are to be kept. The FETCH/WRITE service is still very frequently used for the communication via Industrial Ethernet. The communication processors (CP343-1/CP443-1) of SIMATIC S7 support the services FETCH and WRITE for data exchange on the following protocols:</p>
<ul>
<li>TCP </li>
<li>ISO-on-TCP </li>
<li>ISO transport </li>
</ul>
<p>However, CPUs with integrated Industrial Ethernet interface are increasingly used in S7-300 and S7-400 stations to connect these to the Industrial Ethernet network and to exchange data with other nodes in the network. The FETCH/WRITE services have not been implemented here.</p>
<p>The SIMATIC S7 supports the FETCH and WRITE services only passive via the TCP native and ISO-on-TCP protocol. Furthermore, the SIMATIC S7 CPUs with integrated Industrial Ethernet interface do not support the S5 compatible communication.</p>
</blockquote>
<p>###Structure FETCH/WRITE Header telegram<br> rlSiemensTcp有四个结构体WH,WA,IH,IA</p>
<pre><code>182   typedef struct
183   {
184     unsigned char ident[2];
185     unsigned char header_len;
186     unsigned char ident_op_code;
187     unsigned char op_code_len;
188     unsigned char op_code;
189     unsigned char ident_org_block;
190     unsigned char len_org_block;
191     unsigned char org_block;
192     unsigned char dbnr;
193     unsigned char start_adr[2];
194     unsigned char len[2];
195     unsigned char spare1;
196     unsigned char spare1_len;
197   }WH; // write header
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/WH.PNG" alt="Write Header"></p>
<pre><code>198   typedef struct
199   {
200     unsigned char ident[2];
201     unsigned char header_len;
202     unsigned char ident_op_code;
203     unsigned char op_code_len;
204     unsigned char op_code;
205     unsigned char ack_block;
206     unsigned char ack_block_len;
207     unsigned char error_block;
208     unsigned char spare1;
209     unsigned char spare1_len;
210     unsigned char spare2[5];
211   }WA; // write ack
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/WA.PNG" alt="Write Ack"></p>
<pre><code>212   typedef struct
213   {
214     unsigned char ident[2];
215     unsigned char header_len;
216     unsigned char ident_op_code;
217     unsigned char op_code_len;
218     unsigned char op_code;
219     unsigned char ident_org_block;
220     unsigned char len_org_block;
221     unsigned char org_block;
222     unsigned char dbnr;
223     unsigned char start_adr[2];
224     unsigned char len[2];
225     unsigned char spare1;
226     unsigned char spare1_len;
227   }FH; // fetch header
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/FH.PNG" alt="Fetch Header"></p>
<pre><code>453     fh.ident[0]        = &apos;S&apos;;
454     fh.ident[1]        = &apos;5&apos;;
455     fh.header_len      = 16;
456     fh.ident_op_code   = 1;
457     fh.op_code_len     = 3;
458     fh.op_code         = 5;
459     fh.ident_org_block = 3;
460     fh.len_org_block   = 8;
461     fh.org_block       = (unsigned char) org;
462     fh.dbnr            = (unsigned char) dbnr;
463     fh.start_adr[0]    = (unsigned char) start_adr / 256;
464     fh.start_adr[1]    = (unsigned char) start_adr &amp; 0x0ff;;
465     fh.len[0]          = (unsigned char) len / 256;
466     fh.len[1]          = (unsigned char) len &amp; 0x0ff;;
467     fh.spare1          = 0x0ff;
468     fh.spare1_len      = 2;
</code></pre><p>这是rlSiemensTcp::fetch的部分内容，符合上图，这里构造好报头以后就可以通过Socket通讯连接了.</p>
<pre><code>228   typedef struct
229   {
230     unsigned char ident[2];
231     unsigned char header_len;
232     unsigned char ident_op_code;
233     unsigned char op_code_len;
234     unsigned char op_code;
235     unsigned char ack_block;
236     unsigned char ack_block_len;
237     unsigned char error_block;
238     unsigned char spare1;
239     unsigned char spare1_len;
240     unsigned char spare2[5];
241   }FA; // fetch ack
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/FA.PNG" alt="Fetch Ack"></p>
<p>##Principle of the communication services FETCH and WRITE</p>
<blockquote>
<p>The FETCH and WRITE services are used for the data exchange by means of the following protocols:</p>
<ul>
<li>TCP  </li>
<li>ISO-on-TCP (TCP with RFC1006)  </li>
<li>ISO Transport protocol</li>
</ul>
<p>The SIMATIC S7 CPUs with integrated Industrial Ethernet interface do not support the ISO transport protocol. Here the FETCH and WRITE services for the data exchange are only supported via TCP and ISO-on-TCP protocol.</p>
</blockquote>
<p><img src="http://oxehqp0gf.bkt.clouddn.com/FetchWrite%20ISO.PNG" alt="Fetch/WriteのISO/OSI"></p>
<p>###Fetch</p>
<blockquote>
<p>The FETCH/WRITE client actively establishes the communication<br>connection. It requests the data from the FETCH/WRITE server by means of a FETCH request. The server responds with a positive acknowledgement of the FETCH request and sends the requested data. Otherwise, the acknowledgement of the FETCH response is negative.</p>
</blockquote>
<p>###Write</p>
<p>​    </p>
<blockquote>
<p>The FETCH/WRITE client sends a WRITE request with the data required in the FETCH/WRITE server. If the data has been successfully transmitted, the FETCH/WRITE server responds with a positive acknowledgement. Otherwise, the acknowledgement of the WRITE request is negative.</p>
</blockquote>
<p>###Summary<br><img src="http://oxehqp0gf.bkt.clouddn.com/FW%20Message%20structure.PNG" alt="FETCH/WRITE message structure"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/12/汇编程序的编译与连接/" rel="next" title="">
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiao Maojin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiao Maojin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  

  

  

</body>
</html>

<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="JMJ">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="JMJ">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JMJ">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>JMJ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JMJ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/西门子FETCH-WRITE service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/西门子FETCH-WRITE service/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工控-pvbrowser/" itemprop="url" rel="index">
                    <span itemprop="name">工控 pvbrowser</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0
</code></pre><p>在pvbrowser里设置与PLC连接的时候有一项fetch_write，下面具体看一下这一项</p>
<p>##rlSiemensTcp源码</p>
<pre><code>446   if((plc_type == S5 || plc_type == S7_300 || plc_type == S7_400) &amp;&amp; fetch_write == 1)
 447   {
 448     length = sizeof(ih) + sizeof(fh);
 449     ih.version  = 3;
 450     ih.reserved = 0;
 451     ih.length_high = length / 256;
 452     ih.length_low  = length &amp; 0x0ff;
 453     fh.ident[0]        = &apos;S&apos;;
 454     fh.ident[1]        = &apos;5&apos;;
 455     fh.header_len      = 16;
 456     fh.ident_op_code   = 1;
 457     fh.op_code_len     = 3;
 458     fh.op_code         = 5;
 459     fh.ident_org_block = 3;
 460     fh.len_org_block   = 8;
 461     fh.org_block       = (unsigned char) org;
 462     fh.dbnr            = (unsigned char) dbnr;
 463     fh.start_adr[0]    = (unsigned char) start_adr / 256;
 464     fh.start_adr[1]    = (unsigned char) start_adr &amp; 0x0ff;;
 465     fh.len[0]          = (unsigned char) len / 256;
 466     fh.len[1]          = (unsigned char) len &amp; 0x0ff;;
 467     fh.spare1          = 0x0ff;
 468     fh.spare1_len      = 2;
 469     unsigned char total_buf[sizeof(ih)+sizeof(fh)];
 470     memcpy(total_buf,             &amp;ih, sizeof(ih));
 471     memcpy(total_buf+sizeof(ih),  &amp;fh, sizeof(fh));
 472     ret = rlSocket::write(total_buf,   sizeof(ih)+sizeof(fh));
 473     rlDebugPrintf(&quot;fetch write ih ret=%d\n&quot;,ret);
 474     if(ret &lt; 0) return ret;  
 475     /*
 476     ret = rlSocket::write(&amp;ih,sizeof(ih));
 477     rlDebugPrintf(&quot;fetch write ih ret=%d\n&quot;,ret);
 478     if(ret &lt; 0) return ret;  
 479     ret = rlSocket::write(&amp;fh,sizeof(fh));
 480     rlDebugPrintf(&quot;fetch write fh ret=%d\n&quot;,ret);
 481     if(ret &lt; 0) return ret;
 482     */
 483     ret = rlSocket::read(&amp;ih,sizeof(ih),TIMEOUT);
 484     rlDebugPrintf(&quot;fetch read ih ret=%d\n&quot;,ret);
 485     if(ret &lt;= 0) return ret;
 486     ret = rlSocket::read(&amp;fa,sizeof(fa),TIMEOUT);
 487     rlDebugPrintf(&quot;fetch read fa ret=%d\n&quot;,ret);
 488     if(ret &lt;= 0) return ret;
 489     if(fa.error_block != 0) return -1;
 490     ret = rlSocket::read(buf,len_byte,TIMEOUT);
 491     rlDebugPrintf(&quot;fetch read buf ret=%d\n&quot;,ret);
 492     if(ret &lt;= 0) return ret;
 493   }
</code></pre><p>###判断PLC系列</p>
<pre><code>if((plc_type == S5 || plc_type == S7_300 || plc_type == S7_400) &amp;&amp; fetch_write == 1)
</code></pre><p>首先判断PLC是不是S5，300和400系列。Fetch/Write只支持这些系列，对于像1200，200smart这些是不支持的。<br>并且，在300和400系列中，对于CP343-1，CP443-1是支持Fetch/Write的，对于内嵌Ethernet的CPU需要配置一下。如何配置请查看西门子官方文档《FETCH/WRITE service in an S7-300/400 CPU via the integrated Ethernet interface》.<br>如果不是这些系列的PLC或者fetch_write=0时，则是S7通讯.</p>
<blockquote>
<p>In today’s automation technology old systems are upgraded step by step from SIMATIC S5 to SIMATIC S7. However, the interfaces for the data exchange on the peer (for example, existing HMI systems) are to be kept. The FETCH/WRITE service is still very frequently used for the communication via Industrial Ethernet. The communication processors (CP343-1/CP443-1) of SIMATIC S7 support the services FETCH and WRITE for data exchange on the following protocols:</p>
<ul>
<li>TCP </li>
<li>ISO-on-TCP </li>
<li>ISO transport </li>
</ul>
<p>However, CPUs with integrated Industrial Ethernet interface are increasingly used in S7-300 and S7-400 stations to connect these to the Industrial Ethernet network and to exchange data with other nodes in the network. The FETCH/WRITE services have not been implemented here.</p>
<p>The SIMATIC S7 supports the FETCH and WRITE services only passive via the TCP native and ISO-on-TCP protocol. Furthermore, the SIMATIC S7 CPUs with integrated Industrial Ethernet interface do not support the S5 compatible communication.</p>
</blockquote>
<p>###Structure FETCH/WRITE Header telegram<br> rlSiemensTcp有四个结构体WH,WA,IH,IA</p>
<pre><code>182   typedef struct
183   {
184     unsigned char ident[2];
185     unsigned char header_len;
186     unsigned char ident_op_code;
187     unsigned char op_code_len;
188     unsigned char op_code;
189     unsigned char ident_org_block;
190     unsigned char len_org_block;
191     unsigned char org_block;
192     unsigned char dbnr;
193     unsigned char start_adr[2];
194     unsigned char len[2];
195     unsigned char spare1;
196     unsigned char spare1_len;
197   }WH; // write header
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/WH.PNG" alt="Write Header"></p>
<pre><code>198   typedef struct
199   {
200     unsigned char ident[2];
201     unsigned char header_len;
202     unsigned char ident_op_code;
203     unsigned char op_code_len;
204     unsigned char op_code;
205     unsigned char ack_block;
206     unsigned char ack_block_len;
207     unsigned char error_block;
208     unsigned char spare1;
209     unsigned char spare1_len;
210     unsigned char spare2[5];
211   }WA; // write ack
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/WA.PNG" alt="Write Ack"></p>
<pre><code>212   typedef struct
213   {
214     unsigned char ident[2];
215     unsigned char header_len;
216     unsigned char ident_op_code;
217     unsigned char op_code_len;
218     unsigned char op_code;
219     unsigned char ident_org_block;
220     unsigned char len_org_block;
221     unsigned char org_block;
222     unsigned char dbnr;
223     unsigned char start_adr[2];
224     unsigned char len[2];
225     unsigned char spare1;
226     unsigned char spare1_len;
227   }FH; // fetch header
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/FH.PNG" alt="Fetch Header"></p>
<pre><code>453     fh.ident[0]        = &apos;S&apos;;
454     fh.ident[1]        = &apos;5&apos;;
455     fh.header_len      = 16;
456     fh.ident_op_code   = 1;
457     fh.op_code_len     = 3;
458     fh.op_code         = 5;
459     fh.ident_org_block = 3;
460     fh.len_org_block   = 8;
461     fh.org_block       = (unsigned char) org;
462     fh.dbnr            = (unsigned char) dbnr;
463     fh.start_adr[0]    = (unsigned char) start_adr / 256;
464     fh.start_adr[1]    = (unsigned char) start_adr &amp; 0x0ff;;
465     fh.len[0]          = (unsigned char) len / 256;
466     fh.len[1]          = (unsigned char) len &amp; 0x0ff;;
467     fh.spare1          = 0x0ff;
468     fh.spare1_len      = 2;
</code></pre><p>这是rlSiemensTcp::fetch的部分内容，符合上图，这里构造好报头以后就可以通过Socket通讯连接了.</p>
<pre><code>228   typedef struct
229   {
230     unsigned char ident[2];
231     unsigned char header_len;
232     unsigned char ident_op_code;
233     unsigned char op_code_len;
234     unsigned char op_code;
235     unsigned char ack_block;
236     unsigned char ack_block_len;
237     unsigned char error_block;
238     unsigned char spare1;
239     unsigned char spare1_len;
240     unsigned char spare2[5];
241   }FA; // fetch ack
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/FA.PNG" alt="Fetch Ack"></p>
<p>##Principle of the communication services FETCH and WRITE</p>
<blockquote>
<p>The FETCH and WRITE services are used for the data exchange by means of the following protocols:</p>
<ul>
<li>TCP  </li>
<li>ISO-on-TCP (TCP with RFC1006)  </li>
<li>ISO Transport protocol</li>
</ul>
<p>The SIMATIC S7 CPUs with integrated Industrial Ethernet interface do not support the ISO transport protocol. Here the FETCH and WRITE services for the data exchange are only supported via TCP and ISO-on-TCP protocol.</p>
</blockquote>
<p><img src="http://oxehqp0gf.bkt.clouddn.com/FetchWrite%20ISO.PNG" alt="Fetch/WriteのISO/OSI"></p>
<p>###Fetch</p>
<blockquote>
<p>The FETCH/WRITE client actively establishes the communication<br>connection. It requests the data from the FETCH/WRITE server by means of a FETCH request. The server responds with a positive acknowledgement of the FETCH request and sends the requested data. Otherwise, the acknowledgement of the FETCH response is negative.</p>
</blockquote>
<p>###Write</p>
<p>​    </p>
<blockquote>
<p>The FETCH/WRITE client sends a WRITE request with the data required in the FETCH/WRITE server. If the data has been successfully transmitted, the FETCH/WRITE server responds with a positive acknowledgement. Otherwise, the acknowledgement of the WRITE request is negative.</p>
</blockquote>
<p>###Summary<br><img src="http://oxehqp0gf.bkt.clouddn.com/FW%20Message%20structure.PNG" alt="FETCH/WRITE message structure"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/汇编程序的编译与连接/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/汇编程序的编译与连接/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="汇编程序的编译与连接"><a href="#汇编程序的编译与连接" class="headerlink" title="汇编程序的编译与连接"></a>汇编程序的编译与连接</h1><p>categories:IT</p>
<hr>
<p><strong>本文摘自《汇编语言》，作者王爽</strong></p>
<p>汇编程序写好后，使用汇编语言编译程序对源程序文件中的源程序进行编译，产生目标文件；再用连接程序对目标文件进行连接，生产可在操作系统中直接运行的可执行文件。<br>可执行文件包含两部分：</p>
<blockquote>
<ol>
<li>程序（从源程序汇编语言中翻译过来的机器码）和数据（源程序中定义的数据）</li>
<li>相关的描述信息（比如，程序有多大，要占用多少内存等）。操作系统依据可执行文件的相关描述信息，将可执行文件中的机器码和数据加载入内存，并进行相关初始化（比如设置CS:IP指向第一条要执行的指令），然后由CPU执行程序。</li>
</ol>
</blockquote>
<p>##编译<br>在编译过程中，我们提供一个输入，即源程序文件。最多可以得到三个输出：目标文件（.obj）,列表文件(.lst),交叉引用文件(.crf)。这三个文件中，交叉引用文件是我们最终要得到的结果，而另外两个只是中间结果，可以让编译器忽略对它们的生成。</p>
<p>##连接<br>这里只简单的说一下连接的几个作用。</p>
<ol>
<li>当源程序很大时，可以将它分为几个源程序文件来编译，每个源程序编译成为目标文件后，再用连接程序将他们连接到一起，生成一个可执行文件；</li>
<li>程序中调用来某个库文件中的子程序，需要将这个库文件和该程序生成的目标文件连接到一起，生成一个可执行文件；</li>
<li>一个源程序编译后，得到了存有机器码的目标文件，目标文件中的有些内容还不能直接用来生成可执行文件，连接程序将这些内容处理为最终的可执行信息。所以，在只有一个源程序文件，而又不需要调用某个库中的子程序的情况下，也必须用连接程序对目标文件进行处理，生成可执行文件。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/寄存器（内存访问）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/寄存器（内存访问）/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>本文摘自《汇编语言》，作者王爽</strong></p>
<p>##DS和[address]<br>8086CPU中有一个DS寄存器,通常用来存放要访问数据的段地址。</p>
<blockquote>
<p>move al,[0]</p>
</blockquote>
<p>这里使用move指令将一个内存单元中的内容送入一个寄存器。[0]表示内存单元的偏移地址。只有偏移地址是不能定位一个内存单元的，那么内存的段地址是多少呢？指令执行时，CPU自动取ds中的数据为内存单元的段地址。<br>有一点需要注意的是，8086CPU不支持直接将数据送到段寄存器。所以<strong><em>move ds,1000H</em></strong>这条指令是非法的。应该这样：</p>
<blockquote>
<p>move bx,1000H<br>move ds,bx</p>
</blockquote>
<p>至于为什么8086CPU不支持直接将数据送到段寄存器?这属于8086CPU硬件设计的问题，只需要知道这一点就够了。</p>
<p>##move,add,sub指令总结</p>
<blockquote>
<p>move 寄存器,数据<br>move 寄存器,寄存器<br>move 寄存器,内存单元<br>move 内存单元,寄存器<br>move 段寄存器,寄存器<br>move 寄存器,段寄存器<br>move 内存单元,段寄存器<br>move 段寄存器，内存单元</p>
</blockquote>
<p>add与sub指令与move一样，只是不能对段寄存器进行操作。因为段寄存器不能像通用寄存器那样进行运算，这是硬件限制。而move指令不涉及运算，只是传送指令。</p>
<p>##栈<br>8086CPU的push和pop都是以字为单位进行的。</p>
<p>###两个问题</p>
<p>例如，我们可以把10000H-1000FH这段内存当做栈使用，但是至少有两个问题。</p>
<ol>
<li>CPU如何知道10000H-1000FH这段空间被当做栈使用？</li>
<li>在进行push，pop操作的时候，必须知道栈顶单元，可是，如何知道？</li>
</ol>
<blockquote>
<p>8086CPU中，有两个寄存器，段寄存器SS和寄存器SP。栈顶地址存放在SS中，偏移地址存放在SP中。任意时刻，SS:SP指向栈顶元素。</p>
</blockquote>
<p>###push与pop功能描述<br>这样，我们就可以完整的描述push和pop的功能了，如<strong><em>push ax</em></strong></p>
<blockquote>
<ol>
<li>SP=SP-2，SS:SP指向当前栈顶前面的单元，以当前栈顶前面的单元为新的栈顶。</li>
<li>将ax中的内容送入SS:SP指向内存单元处，SS:SP指向新栈顶。</li>
</ol>
</blockquote>
<p>pop执行过程与push刚好相反，<strong><em>pop ax</em></strong></p>
<blockquote>
<ol>
<li>将SS:SP指向的内存单元处的数据送入ax</li>
<li>SP=SP+2，SS:SP指向当前栈顶下面的单元，以当前栈顶下面的单元为新的栈顶。</li>
</ol>
</blockquote>
<p>push和pop都可以操作寄存器，段寄存器和内存单元。</p>
<blockquote>
<p>push 寄存器<br>push 段寄存器<br>push 内存单元</p>
</blockquote>
<p>###栈顶超界<br>8086帮助我们解决栈顶超界问题，自己使用时注意。既要防止入栈太多导致超界，也要防止栈空的时候出栈导致的超界。</p>
<p>###栈为什么逆向生长<br><strong><em>这段内容摘自《Reverse Engineering for Beginners》，作者：Dennis Yurichev</em></strong></p>
<p>The reason that the stack grows backward is probably historical. When the computers were big and occupied a whole room, it was easy to divide memory into two parts, one for the heap and one for the stack. Of course, it was unknown how big the heap and the stack would be during program execution, sothis solution was the simplest possible.<br>In [D. M. Ritchie and K. Thompson, The UNIX Time Sharing System, (1974)]we can read：</p>
<blockquote>
<p>The user-core part of an image is divided into three logical segments.<br>The program text segment begins at location 0 in the virtual address<br>space. During execution, this segment is write-protected and a single<br>copy of it is shared among all processes executing the same program.<br>At the first 8K byte boundary above the program text segment in the<br>virtual address space begins a nonshared, writable data segment, the<br>size of which may be extended by a system call. Starting at the<br>highest address in the virtual address space is a stack segment, which<br>automatically grows downward as the hardware’s stack pointer<br>fluctuates.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/pvbrowser如何通过Siemens tcp连接PLC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/pvbrowser如何通过Siemens tcp连接PLC/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工控-pvbrowser/" itemprop="url" rel="index">
                    <span itemprop="name">工控 pvbrowser</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>pvbrowser是一款德国的基于Qt的开源组态软件。尽管市场中用的很少，我们还是可以通过看其源码学习很多东西。</p>
<p>pvbrowser里有两种方式通过Simens tcp与PLC通讯:Daemon与pvbaddon.</p>
<p>##Daemon</p>
<p>###通过Daemon生成EXE文件<br>打开pvdevelop，选择<em>菜单栏-&gt;daemon-&gt;Siemens Tcp</em></p>
<pre><code>shared_memory=C:\\automation\\shm\\siemens.shm
mailbox=C:\\automation\\mbx\\siemens.mbx
# type := S7_200 | S7_300 | S7_400 | S5 | S7_1200 | LOGO
slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0
idletime=50 milliseconds
#eventlog host=localhost port=6000
# ORG := ORG_DB | ORG_M | ORG_E | ORG_A | ORG_PEPA | ORG_Z | ORG_T
# cycle := slave + org + dbnum + start + len
cycle1 slave=0 org=ORG_E  dbnum=0 start=0 len=1
cycle2 slave=0 org=ORG_A  dbnum=0 start=0 len=1
</code></pre><p>这里面有以下几个需要注意的点:</p>
<ol>
<li>shared memory和mailbox的文件路径是需要自己建的，这个软件不会给你建。<br>Note that these directories must be created first by you. Note that the size of the shared memory must be equal in the daemon and in the pvserver.<br>2.关于 fetch_write的设定<br>fetch_write=1为fetch/write服务,fetch_write=0为S7连接。<br>(1) There is the old Fetch/Write protocol from the old S5 PLC<br>(fetch_write=1).Fetch/Write只支持S5和300，400系列.<br>(2) And there is the current Siemens PLC protocol introduced with the S7 series of PLC (fetch_write=0).</li>
<li>FUNCTION    := optional parameter for PLC (1=PG,2=OP,3=Step7Basic)<br>经验证123均可连通。</li>
<li>经验证，rack_slot这个值设随机值都能通</li>
<li>ORG_E指的是Eingang(输入)，ORG_A指的是Ausgang(输出)，ORG_M是Merker(这个单词没查到，经验证是M区)，ORG_DB是Datenbaustein(DB区).此外还有ORG_PEPA指的是Peripheral(外围设备) Area R/W ，ORG_Z意思是Zaehler(计数器),ORG_T意思是Timer(计时器)<br>设置好以后点compile，然后点close.<br>这时，项目文件夹下会生成siemensdaemon.cpp,siemensdaemon.h,siemensdaemon.exe和siemensdaemon.mksimens四个文件<br>运行siemensdaemon.exe文件，数据就从PLC里面读取到共享内存里了(可能会遇到缺少*.dll文件，在pvbrowser安装目录里找到对应的文件放进项目文件即可)。<br>###如何进行调试<br>当我们遇到连接不通的时候怎么办呢，因为是pvbrowser是基于Qt的，我们可以通过Qt对其进行调试。</li>
<li>新建空Qt控制台项目，添加Deamon生成的siemensdaemon.h和siemensdaemon.cpp文件。并将缺少的头文件放到目录里，这些头文件可以在pvb安装目录底下找到。</li>
<li><p>在该项目的makefile里添加</p>
<p> win32-g++ {<br> QMAKE_LFLAGS      += -static-libgcc<br> win32:LIBS        += $(PVBDIR)/win-mingw/bin/libserverlib.a<br> win32:LIBS        += $(PVBDIR)/win-mingw/bin/librllib.a<br> win32:LIBS        += -lws2_32 -ladvapi32 -lpthread<br> win32:INCLUDEPATH += $(PVBDIR)/pvserver<br> win32:INCLUDEPATH += $(PVBDIR)/rllib/lib<br> }</p>
</li>
</ol>
<p>这样项目就建好了，可以进行更改调试。</p>
<p>##pvbaddon<br>可以在pvbrowser下载pvbaddon<br>在pvbaddon\pvbaddon\daemons\siemenstcp\client\release目录下有siemenstcp_client.exe 文件，需要配合ini文件使用。<br>example.ini</p>
<pre><code># ini file for siemenstcp_client
#
# DEBUG       := 1 | 0
# SLAVE&lt;N&gt;    := IP,PLC_TYPE,FETCH_WRITE,FUNCTION,RACK_SLOT
# PLC_TYPE    := ANY | S7_200 | S7_300 | S7_400 | S5 | S7_1200 | LOGO
# FETCH_WRITE := 1 | 0 # default 1
# FUNCTION    := optional parameter for PLC (1=PG,2=OP,3=Step7Basic)
# RACK_SLOT   := optional parameter for PLC  Byte(upper_3_bit_is_rack / lower_5_bit_is_slot)
# CYCLE&lt;N&gt;    := &lt;count&gt;,&lt;name&gt;
# name        := byte&lt;ORG&gt;(slave,dbnum,adr)   | 
#                float&lt;ORG&gt;(slave,dbnum,adr)  |
#                dword&lt;ORG&gt;(slave,dbnum,adr)  |
#                short&lt;ORG&gt;(slave,dbnum,adr)  |
#                udword&lt;ORG&gt;(slave,dbnum,adr) |
#                ushort&lt;ORG&gt;(slave,dbnum,adr)
# ORG         := ORG_DB | ORG_M | ORG_E | ORG_A | ORG_PEPA | ORG_Z | ORG_T
# HAVETO_SWAP := 1 | 0 # must be 1 on intel machines
# CYCLETIME in milliseconds
# SHARED_MEMORY_SIZE must be equal to SHARED_MEMORY_SIZE of pvserver
# MAX_NAME_LENGTH is maximum length of variable name in shared memory 
#

[GLOBAL]
DEBUG=1
CYCLETIME=1000
HAVETO_SWAP=1

[SOCKET]
NUM_SLAVES=1
SLAVE1=192.168.1.101,ANY,0
#SLAVE2=192.168.1.35,S7_200,0,1,2

# You may also specify the TSAPs explicitly.
# In that case the PLC_TYPE does not care. Use ANY.
[SLAVE1_CONNECT_BLOCK]
#S7-200
CB13=&apos;M&apos; # remote TSAP        (not necessary to set explicitly)
CB14=&apos;W&apos; # remote TSAP        (not necessary to set explicitly)
CB17=&apos;M&apos; # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
CB18=&apos;W&apos; # local  TSAP slot 1 (upper_3_bit_is_rack / lower_5_bit_is_slot)
#S7-300
#CB13=2 # remote TSAP        (not necessary to set explicitly)
#CB14=1 # remote TSAP        (not necessary to set explicitly)
#CB17=1 # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
#CB18=2 # local  TSAP slot 2 (upper_3_bit_is_rack / lower_5_bit_is_slot)
#S7-400
#CB13=2 # remote TSAP        (not necessary to set explicitly)
#CB14=1 # remote TSAP        (not necessary to set explicitly)
#CB17=1 # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
#CB18=3 # local  TSAP slot 3 (upper_3_bit_is_rack / lower_5_bit_is_slot)
#S7-1200
#CB13=2 # remote TSAP        (not necessary to set explicitly)
#CB14=1 # remote TSAP        (not necessary to set explicitly)
#CB17=1 # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
#CB18=0 # local  TSAP slot 0 (upper_3_bit_is_rack / lower_5_bit_is_slot)

[RLLIB]
MAX_NAME_LENGTH=30
SHARED_MEMORY=/srv/automation/shm/siemenstcp1.shm
SHARED_MEMORY_SIZE=65536
MAILBOX=/srv/automation/mbx/siemenstcp1.mbx

[CYCLES]
NUM_CYCLES=4
CYCLE1=10,byteORG_M(1,0,0)
CYCLE2=4,byteORG_E(1,0,0)
CYCLE3=4,byteORG_A(1,0,0)
CYCLE4=4,byteORG_DB(1,1,0)
#CYCLE2=1,byteORG_M(2,2,3)
</code></pre><p>这里我没有做更改，更改的话与Deamon需要注意的地方相同。<br>打开cmd cd到该目录下运行</p>
<pre><code>siemenstcp_client.exe example.ini
</code></pre><p>数据就到mailbox里面了</p>
<p>调试的话，里面有Qt项目文件可以直接打开</p>
<p>这样PLC数据就读取到shared memory或mailbox里了，可以进行后期的上位编程。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/Kepware与 smart200建立连接的方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/Kepware与 smart200建立连接的方法/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工控/" itemprop="url" rel="index">
                    <span itemprop="name">工控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##建通道</p>
<ol>
<li>建立通道channel1</li>
<li>选择设备驱动    设备驱动选择 siemens TCP/IP Ethernet</li>
<li>选择本机网卡</li>
<li>下一步直到完成<br>##建设备</li>
<li>新建设备decice1.</li>
<li><strong>选择设备 s7-200</strong></li>
<li>输入smart 200PLC的地址</li>
<li><strong>最重要的一步：修改参数，把两个4D57改成201</strong><br>##建变量<br>新建变量<br>运行测试</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/CPU寻址/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/CPU寻址/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>本文摘自《汇编原理（第二版）》，作者王爽</strong></p>
<p>##CPU组成##<br>一个典型的CPU由运算器、控制器、寄存器等器件构成，这些器件靠内部总线相连。简单的讲，在CPU中：</p>
<blockquote>
<ul>
<li>运算器进信息处理；</li>
<li>寄存器进行信息存储；</li>
<li>控制器控制各种器件进行工作；</li>
<li>内部总线连接各种器件，在它们之间进行数据的传送。</li>
</ul>
</blockquote>
<p>####通用寄存器####<br>8086CPU的所有寄存器都是16位的。AX、BX、CX、DX这4个寄存器通常用来存放一般性的数据，被称为通用寄存器。<br>8086CPU的上一代CPU中的寄存器都是8位的，为了保证兼容，使原来基于上代CPU编写的程序稍加修改就可以运行在8086之上，8086CPU的AX、BX、CX、DX这4个寄存器都可分为两个独立使用的8位寄存器来用：例如AX可分为AH和AL。<br>出于对兼容性的考虑，8086CPU可以一次性处理以下两种尺寸的数据：字节和字。</p>
<blockquote>
<p>将AX分为AH和AI使用时，CPU在执行指令的时候认为AH和AL是两个不相关的寄存器。不要错误的认为i，诸如add al,93H的指令产生的进位会存储在ah中，add al,93H进行的8位运算。</p>
</blockquote>
<p>##CPU如何在内部形成内存单元的物理地址<br>8086是16位结构的CPU，什么是16位结构的CPU呢？</p>
<ol>
<li>运算器一次最多可以处理16位的数据； </li>
<li>存储器的最大宽度为16位；</li>
<li>寄存器和运算器之间的通路为16位。</li>
</ol>
<p>这也就是说，在8086内部，能够一次性处理、传输、暂时存储的信息最大长度是16位的（是不是32位系统与64位系统也是这样，除了在内存上有差别还在性能上有差别？）。内存单元的地址在送上地址总线之前，必须在CPU中处理、传输、暂时存放，对于16位的CPU，能一次性处理、传输、暂存16位的地址。但是，8086有20位地址总线，怎么办？<br><strong><em>8086CPU采用一种在内部用两个16位地址合成（通过地址加法器）的方法来形成一个20位物理地址。</em></strong><br>当8086CPU要读写内存时：</p>
<blockquote>
<ol>
<li>CPU中的相关部件提供两个16位的地址，一个成为段地址，另一个称为偏移地址；</li>
<li>段地址和偏移地址通过内部总线送入一个成位地址加法器的部件；</li>
<li>地址加法器将两个16位地址合成为一个20位的物理地址；</li>
<li>地址加法器通过内部总线将20位物理地址送入输入输出控制电路；</li>
<li>输入输出控制电路将20位物理地址送上地址总线；</li>
<li>20位物理地址被地址总线传送到存储器。</li>
</ol>
</blockquote>
<p>地址加法器采用<strong><em>物理地址=段地址×16+偏移地址</em></strong>的方式合成物理地址。<br>例如两个16位，1230和00C8，1230*16=12300（左移4位）。12300+00C8=123C8。</p>
<p>##段的概念##<br>段地址包含着段的概念，其实不是内存分段，段的划分来自CPU，由于8086CPU用“<strong>基础地址（段地址*16）+偏移地址=物理地址</strong>”的方式给出的内存单元的物理地址，使得我们可以用分段的方式来管理内存。<br>对于同一地址比如10000H~100FFH的内存单元，可以有很多种表示方式</p>
<ol>
<li>基础地址为10000H，段地址为1000H，大小为100H；</li>
<li>可以认为10000H~1007FH、10080H~100FFH内存单元组成两个段，它们的基础地址为：10000H和10080H，段地址为：1000H和1008H，大小都为80H。</li>
</ol>
<p>有两点需要注意：</p>
<blockquote>
<ul>
<li>段地址*16必然是16的倍数，所以一个段的起始地址也一定是16的倍数；</li>
<li>偏移地址为16位，16位地址的寻址能力为64KB，所以一个段的长度最大为64KB</li>
</ul>
</blockquote>
<p>##段寄存器##<br>段地址在8086CPU的段寄存器中存放。8086CPU有4个段寄存器：CS、DS、SS、ES。<strong><em>其中CS用来存放指令的段地址。</em></strong></p>
<p>##CS和IP##<br>CS和IP是8086CPU中最关键的寄存器，它们指示了CPU当前要读指令的地址。CS为代码段寄存器，IP为指令指针寄存器，即CS*16+IP。<br>8086CPU的工作过程：</p>
<ol>
<li>从CS：IP指向的内存单元读取指令，读取指令进入指令缓冲器；</li>
<li>IP指向下一条指令；</li>
<li>执行指令。（转到步骤1，重复这个过程）<blockquote>
<p>8086机中，任意时刻，CPU将CS：IP指向的内容当作指令执行。<br>在内存中，指令和数据没有任何区别，都是二进制信息，CPU在工作的时候把有的信息看作指令，有的信息看作数据。现在，如果提出一个问题：CPU根据什么将内存中的信息看作指令？如何回答？我们可以说，CPU将CS：IP指向的内存单元中的内容看作指令。</p>
</blockquote>
</li>
</ol>
<p>注意move指令不能改变CS、IP寄存器中的内容。能够改变CS、IP的内容的指令被统称为转移指令。如jump指令。</p>
<p>##这本书中的第二章实验1可以多看几遍##</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/CPU如何控制器件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/CPU如何控制器件/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T20:23:37+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>本文摘自《汇编语言》，作者王爽</strong></p>
<p>##总线##<br>CPU想要进行数据的读写，必须和外部器件进行以下3类信息的交互。</p>
<blockquote>
<ul>
<li>存储单元的地址（地址信息）</li>
<li>器件的选择，读或写的命令（控制信息）</li>
<li>读或写的数据（数据信息）</li>
</ul>
</blockquote>
<p>通常将连接CPU和其他芯片的导线，称为总线。因此，总线从逻辑上分为3类，地址总线、控制总线和数据总线。<br>我们知道了CPU是如何进行数据读写的。可是，如何命令计算机进行数据的读写呢？<br>要让一个计算机或微处理器工作，应向它输入能够驱动它进行工作的电平信息（汇编指令，机器码）</p>
<p>##接口卡##<br>计算机系统中，所有可用程序控制其工作的设备，必须收到CPU的控制。CPU对外部设备都不能直接控制，如显示器、音响、打印机等。直接控制这些设备进行工作的是插在扩展插槽上的接口卡。扩展插槽通过总线和CPU相连，所以接口卡也通过总线同CPU相连。CPU可以直接控制这些接口卡，从而实现CPU对外设的间接控制。简单的讲<strong><em>，就是CPU通过总线向接口卡发送命令，接口卡根据CPU的命令控制外设进行工作</em></strong>。</p>
<p>##各类存储器芯片##<br>主要有RAM和ROM</p>
<p>###随机存储器###<br>主随机存储器一般由两个位置上的RAM组成，装在主板上的RAM和插在扩展槽上的RAM。</p>
<p>###装有BIOS的ROM###<br>BIOS是由主板和各类接口卡（如显卡、网卡等）厂商提供的软件系统，可以通过它利用该硬件设备进行最基本的输入输出。在主板和某些接口卡上茶有存储相应BIOS的ROM，例如，主板上的ROM中存储着主板的BIOS；显卡上的ROM中存储着显卡的BIOS；如果网卡上装有ROM，那么其中就可以存储网卡的BIOS。</p>
<p>###接口卡上的RAM###<br>某些接口卡需要对大批量输入输出数据进行暂时存储，在其上装有RAM。最典型的是显存。显卡随时将显存中的数据向显示器输出。换句话说，我们将需要显示的内容写入显存，就会出现在显示器上。</p>
<p>###内存地址空间###<br>上述的那些存储器，在物理上是独立的器件，但是在以下两点上相同。</p>
<blockquote>
<ul>
<li>都和CPU的总线相连。</li>
<li>CPU对他们进行读写的时候都通过控制线发出内存读写命令。</li>
</ul>
</blockquote>
<p>这就是说，<strong><em>CPU在操纵它们的时候，把它们都当作内存来对待</em></strong>。<br>所有的物理存储器被看作一个由若干存储单元组成的逻辑存储器，每个物理存储器在这个逻辑存储器中占有一个地址段，即一段地址空间。CPU在这段地址空间中读写数据，实际上就是在对相对应的物理存储器中读写数据。<br>例如：</p>
<blockquote>
<p>地址0~7FFFH的32KB空间为主村级存储器地址空间；<br>地址8000H~9FFFH的8KB空间为显存地址空间；<br>地址A000H~FFFFH的24KB空间为各个ROM的地址空间。</p>
</blockquote>
<p>这样，CPU向内存地址为1000H的内存单元中写入数据，这个数据就被写入主随机存储器；CPU向内存地址为8000H的内存单元中写入数据，这个数据就被写入显存中，然后会被显卡输出到显示器上；CPU向内存地址为C00H的内存单元中写入数据的操作是没有结果的，因为是ROM。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/28/可重入与线程安全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/28/可重入与线程安全/" itemprop="url">可重入与线程安全</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-28T00:00:00+08:00">
                2017-12-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="可重入与线程安全"><a href="#可重入与线程安全" class="headerlink" title="可重入与线程安全"></a>可重入与线程安全</h1><blockquote>
<p>本文 摘自Qt官方文档</p>
</blockquote>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li>A thread-safe function can be called simultaneously from multiple threads, even when the invocations use shared data, because all references to the shared data are serialized.</li>
<li>A reentrant function can also be called simultaneously from multiple threads, but only if each invocation uses its own data.</li>
</ul>
<p>Hence, a thread-safe function is always reentrant, but a reentrant function is not always thread-safe.</p>
<p>By extension, a class is said to be reentrant if its member functions can be called safely from multiple threads, as long as each thread uses a different instance of the class. The class is thread-safe if its member functions can be called safely from multiple threads, even if all the threads use the same instance of the class.</p>
<h2 id="可重入"><a href="#可重入" class="headerlink" title="可重入"></a>可重入</h2><p>C++ classes are often reentrant, simply because they only access their own member data. Any thread can call a member function on an instance of a reentrant class, as long as no other thread can call a member function on the same instance of the class at the same time. For example, the Counter class below is reentrant:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span></span></div><div class="line"><span class="class"> &#123;</span></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">     Counter() &#123; n = <span class="number">0</span>; &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123; ++n; &#125;</div><div class="line">     <span class="function"><span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123; --n; &#125;</div><div class="line">     <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> n; &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">     <span class="keyword">int</span> n;</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<p>The class isn’t thread-safe, because if multiple threads try to modify the data member n, the result is undefined. This is because the ++ and – operators aren’t always atomic. Indeed, they usually expand to three machine instructions:</p>
<ol>
<li>Load the variable’s value in a register.</li>
<li>Increment or decrement the register’s value.</li>
<li>Store the register’s value back into main memory.</li>
</ol>
<p>If thread A and thread B load the variable’s old value simultaneously, increment their register, and store it back, they end up overwriting each other, and the variable is incremented only once! </p>
<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p>Clearly, the access must be serialized: Thread A must perform steps 1, 2, 3 without interruption (atomically) before thread B can perform the same steps; or vice versa. An easy way to make the class thread-safe is to protect all access to the data members with a QMutex:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span></span></div><div class="line"><span class="class">  &#123;</span></div><div class="line">  <span class="keyword">public</span>:</div><div class="line">      Counter() &#123; n = <span class="number">0</span>; &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123; <span class="function">QMutexLocker <span class="title">locker</span><span class="params">(&amp;mutex)</span></span>; ++n; &#125;</div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123; <span class="function">QMutexLocker <span class="title">locker</span><span class="params">(&amp;mutex)</span></span>; --n; &#125;</div><div class="line">      <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="function">QMutexLocker <span class="title">locker</span><span class="params">(&amp;mutex)</span></span>; <span class="keyword">return</span> n; &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">      <span class="keyword">mutable</span> QMutex mutex;</div><div class="line">      <span class="keyword">int</span> n;</div><div class="line">  &#125;;</div></pre></td></tr></table></figure></p>
<p>The QMutexLocker class automatically locks the mutex in its constructor and unlocks it when the destructor is invoked, at the end of the function. Locking the mutex ensures that access from different threads will be serialized. The mutex data member is declared with the mutable qualifier because we need to lock and unlock the mutex in value(), which is a const function. </p>
<h2 id="个人简单概括"><a href="#个人简单概括" class="headerlink" title="个人简单概括"></a>个人简单概括</h2><p>我也上网看了很多博客，感觉网上关于这俩的说法都有些矛盾，这里就以Qt官方为准吧。</p>
<p>可重入是针对类的两个实例，像全局变量这样的，会被调用两次因此结果不确定，对于两个实例自己的变量没事。</p>
<p>线程安全是针对的类的一个实例，即即使是私有变量也可能被调两次，这样的需要“be serialized”.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/27/比较句/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/27/比较句/" itemprop="url">比较句</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-27T00:00:00+08:00">
                2017-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/英语/" itemprop="url" rel="index">
                    <span itemprop="name">英语</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="比较句"><a href="#比较句" class="headerlink" title="比较句"></a>比较句</h1><blockquote>
<p>本文转自2017-12-19天天用英语</p>
</blockquote>
<p>目标句：</p>
<blockquote>
<p>Life’s transition from the sea to the land was as much of an evolutionary challenge as was the genesis of life.</p>
</blockquote>
<h2 id="比较句是特殊的并列句"><a href="#比较句是特殊的并列句" class="headerlink" title="比较句是特殊的并列句"></a>比较句是特殊的并列句</h2><blockquote>
<ol>
<li>Life’s transition from the sea to the land was an evolutionary challenge.</li>
<li>The genesis of life was an evolutionary challenge.</li>
</ol>
</blockquote>
<p>合成:</p>
<blockquote>
<p>Life’s transition from the sea to the land was as an evolutionary challenge as  the genesis of life ==was an evolutionary challenge==</p>
</blockquote>
<h2 id="尽量不要省略谓语动词"><a href="#尽量不要省略谓语动词" class="headerlink" title="尽量不要省略谓语动词"></a>尽量不要省略谓语动词</h2><ul>
<li>Marry is more beautiful than Jenny.</li>
</ul>
<p>这个没问题</p>
<ul>
<li>I like her more than you</li>
</ul>
<p>意思一：我喜欢她，你也喜欢她，但是我比你更喜欢她</p>
<pre><code>I like her more than you do
</code></pre><p>意思二：我喜欢你，我也喜欢她，但是你俩比起来，我更喜欢她</p>
<p>​        I like her more than I like you</p>
<blockquote>
<p>Life’s transition from the sea to the land was as an evolutionary challenge as the genesis of life ==was== </p>
</blockquote>
<h2 id="第二个句子的谓语动词可以倒装"><a href="#第二个句子的谓语动词可以倒装" class="headerlink" title="第二个句子的谓语动词可以倒装"></a>第二个句子的谓语动词可以倒装</h2><p>Data loads have a much smaller impact on performance than do merges.</p>
<p>与数据合并相比，数据加载对性能的影响要小得多</p>
<blockquote>
<p>Life’s transition from the sea to the land was as much of an evolutionary challenge as ==was== the genesis of life.</p>
</blockquote>
<h2 id="比较名词属性"><a href="#比较名词属性" class="headerlink" title="比较名词属性"></a>比较名词属性</h2><ol>
<li><p>“more”后面要加上一个”of”</p>
<p>He is more of a strategist than of a tactician.</p>
</li>
<li><p>“as”后面要加上“much of”</p>
<p>He was quite as much of a Rationalist as I am.</p>
</li>
</ol>
<blockquote>
<p>Life’s transition from the sea to the land was as ==much of== an evolutionary challenge as ==was== the genesis of life.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/26/天分重要吗/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/26/天分重要吗/" itemprop="url">天分重要吗</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-26T00:00:00+08:00">
                2017-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#天分重要吗</p>
<blockquote>
<p>本文摘自尹航的训练营理论课5：天分重要吗</p>
</blockquote>
<p>​    大家上学的时候有没有听老师或者父母或者其它同学的父母说过这样的话：”哎呀，这孩子特别聪明，就是不细心，不然他学习特别好。“（这里的不细心可以换成没有耐心，不过认真等等）</p>
<p>​    总之，在他们看来，这孩子是有天分的，但是没有用好，他只要善加利用了就肯定能做出不错的成绩。</p>
<p>​    这个是个特别大的误区，本质上这是在表示天赋是最重要的，并且骨子里散发着一种特别高傲的情绪，在他们看来认真，细心，耐心都是特别容易得到的品质或者是你身上的固有属性，你有只是你不用。</p>
<p>​    那你说这样的话让那些这么多年认真做事的人情何以堪呢，为什么没有人说只要你聪明一点就可以了呢。因为大家都觉得聪明是天生的，而认真和耐心是人人都有的，只要你调用出来就可以了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiao Maojin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiao Maojin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  

  

  

</body>
</html>

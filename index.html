<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="JMJ">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="JMJ">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JMJ">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>JMJ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JMJ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/读Qt示例之Modbus Master example(一)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/读Qt示例之Modbus Master example(一)/" itemprop="url">读Qt示例之Modbus Master example(一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:10+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index">
                    <span itemprop="name">Qt</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>﻿#读Qt示例之Modbus Master example(一)#</p>
<p>本示例来自于Qt5.6.2</p>
<p>本篇主要看WriteRegisterModel这个模型类是怎么实现的<br>涉及知识点主要是model/view中的model<br><img src="http://img.blog.csdn.net/20170716184111963?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnNuQWx0cmlh/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="Modbus Master示例的界面"></p>
<p>WriteRegisterModel有四个变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public:</div><div class="line">	int m_number;            //读写的个数</div><div class="line">    int m_address;           //读写的起始位置</div><div class="line">	QBitArray m_coils;          //Coils</div><div class="line">    QVector&lt;quint16&gt; m_holdingRegisters;//HoldlingRegister</div></pre></td></tr></table></figure>
<p>Modbus 一共有四组变量，其中可写的是 Coils，HoldingRegisters<br>该示例每组变量一共有10个值，m_address是起始位置，m_number是从起始位置开始读几个。</p>
<p>##实现只读功能##<br>该模型是二维的，因此除了构造函数以外，只需要实现三个函数:rowCount(),columnCount()和data()函数。如果是字符串列表那样一维的，则只需实现rowCount()和data()函数。如果模型是树状图那样的层次结构，还需要实现index()和parent()函数.<br>其中rowCount(),columnCount()返回模型的行列数，data()返回指定模型索引的数据项。<br>也可以实现headerData()函数，它是显示表头的。</p>
<p>先看看构造函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">WriteRegisterModel::WriteRegisterModel(QObject *parent)</div><div class="line">    : QAbstractTableModel(parent),</div><div class="line">      m_coils(RowCount, false), m_holdingRegisters(RowCount, 0u)</div><div class="line">&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有rowCount(),columnCount()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">int WriteRegisterModel::rowCount(const QModelIndex &amp;/*parent*/) const</div><div class="line">&#123;</div><div class="line">    return RowCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int WriteRegisterModel::columnCount(const QModelIndex &amp;/*parent*/) const</div><div class="line">&#123;</div><div class="line">    return ColumnCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这几个没啥好说的<br>data()函数:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">QVariant WriteRegisterModel::data(<span class="keyword">const</span> QModelIndex &amp;index, <span class="keyword">int</span> role) <span class="keyword">const</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!index.isValid() || index.row() &gt;= RowCount || index.column() &gt;= ColumnCount)</div><div class="line">        <span class="keyword">return</span> QVariant();<span class="comment">//要求索引有效，行列号在大小范围之内</span></div><div class="line"></div><div class="line">    Q_ASSERT(m_coils.count() == RowCount);</div><div class="line">    Q_ASSERT(m_holdingRegisters.count() == RowCount);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (index.column() == NumColumn &amp;&amp; role == Qt::DisplayRole)<span class="comment">//NumColumn被枚举为0</span></div><div class="line">        <span class="keyword">return</span> QString::number(index.row());<span class="comment">//第一列返回行号</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (index.column() == CoilsColumn &amp;&amp; role == Qt::CheckStateRole) <span class="comment">// coils</span></div><div class="line">        <span class="keyword">return</span> m_coils.at(index.row()) ? Qt::Checked : Qt::Unchecked;<span class="comment">//返回是否被选中(at返回该位置的值)</span></div><div class="line"></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (index.column() == HoldingColumn &amp;&amp; role == Qt::DisplayRole) <span class="comment">//holding registers</span></div><div class="line">        <span class="keyword">return</span> QString(<span class="string">"0x%1"</span>).arg(QString::number(m_holdingRegisters.at(index.row()), <span class="number">16</span>));<span class="comment">//以十六进制返回指定位置的值</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> QVariant();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>headerData()函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">QVariant WriteRegisterModel::headerData(int section, Qt::Orientation orientation, int role) const</div><div class="line">&#123;</div><div class="line">    if (role != Qt::DisplayRole)</div><div class="line">        return QVariant();</div><div class="line"></div><div class="line">    if (orientation == Qt::Horizontal) &#123;</div><div class="line">        switch (section) &#123;</div><div class="line">        case NumColumn:</div><div class="line">            return QStringLiteral(&quot;#&quot;);</div><div class="line">        case CoilsColumn:</div><div class="line">            return QStringLiteral(&quot;Coils  &quot;);</div><div class="line">        case HoldingColumn:</div><div class="line">            return QStringLiteral(&quot;Holding Registers&quot;);</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return QVariant();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##添加写功能##<br>为了使模型可编辑,需要另外两个函数flags()和setData()<br>flags():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Qt::ItemFlags WriteRegisterModel::flags(const QModelIndex &amp;index) const</div><div class="line">&#123;</div><div class="line">    if (!index.isValid() || index.row() &gt;= RowCount || index.column() &gt;= ColumnCount)</div><div class="line">        return QAbstractTableModel::flags(index);</div><div class="line"></div><div class="line">    Qt::ItemFlags flags = QAbstractTableModel::flags(index);</div><div class="line">    if ((index.row() &lt; m_address) || (index.row() &gt;= (m_address + m_number)))//如果index小于起始位置，大于结束位置，则返回0</div><div class="line">        flags &amp;= ~Qt::ItemIsEnabled;//？不懂返回为什么这么写？</div><div class="line"></div><div class="line">    if (index.column() == CoilsColumn) //coils</div><div class="line">        return flags | Qt::ItemIsUserCheckable;</div><div class="line">    if (index.column() == HoldingColumn) //holding registers</div><div class="line">        return flags | Qt::ItemIsEditable;</div><div class="line"></div><div class="line">    return flags;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>委托在创建编辑器以前会检测项目是否是可编辑的，模型必须让委托知道它的项目是可编辑的，这里为模型中的每一个项目返回一个正确的标识来达到这个目的。<br>setData():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">bool WriteRegisterModel::setData(const QModelIndex &amp;index, const QVariant &amp;value, int role)</div><div class="line">&#123;</div><div class="line">    if (!index.isValid() ||  index.row() &gt;= RowCount || index.column() &gt;= ColumnCount)</div><div class="line">        return false;</div><div class="line"></div><div class="line">    Q_ASSERT(m_coils.count() == RowCount);//如果()里为0，返回警告</div><div class="line">    Q_ASSERT(m_holdingRegisters.count() == RowCount);</div><div class="line"></div><div class="line">    if (index.column() == CoilsColumn &amp;&amp; role == Qt::CheckStateRole) &#123; // coils</div><div class="line">        auto s = static_cast&lt;Qt::CheckState&gt;(value.toUInt());//？这里的类型转换为什么要这样？</div><div class="line">        s == Qt::Checked ? m_coils.setBit(index.row()) : m_coils.clearBit(index.row());</div><div class="line">        emit dataChanged(index, index);</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (index.column() == HoldingColumn &amp;&amp; Qt::EditRole) &#123; // holding registers</div><div class="line">        bool result = false;</div><div class="line">        quint16 newValue = value.toString().toUShort(&amp;result, 16);//？还有这里？</div><div class="line">        if (result)</div><div class="line">            m_holdingRegisters[index.row()] = newValue;</div><div class="line"></div><div class="line">        emit dataChanged(index, index);</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意，我们并不需要知道委托是怎样执行真正的编辑操作的，而只需要为委托向模型中设置一条途径，这个是通过setData()函数实现的<em>（个人理解，这里不需要知道是怎样执行的是指:比如我没有找到setData函数被调用的地方，应该就是这种吧）</em><br><strong>当数据被设置后，模型必须让视图知道有数据已经改变了，这就是最后都有个emit dataChanged(index, index);的意义</strong></p>
<p>setData函数就是给这个item设置一个QVariant的值，但是，这个函数有两个参数，第一个QVariant自然是需要设置的值，另一个是一个int型数据，Qt中把这个称为role角色，所谓角色，是指设定进item的这个Qvariant所扮演的角色，实际就是对设定值的标定，因为item可以设置许多值，这就需要一个用以区分的标志，这个区分标志就叫角色。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/读Qt示例之addressbook（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/读Qt示例之addressbook（一）/" itemprop="url">读Qt示例之addressbook（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:10+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index">
                    <span itemprop="name">Qt</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#读Qt示例之addressbook（一）#<br><img src="http://img.blog.csdn.net/20170711214756973?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnNuQWx0cmlh/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br>这里看的示例是QT5.6.2的<br>addressbook 是将联系人按英文字母顺序，3个字母一组显示联系人及其地址的一个示例。<br>address book 包含5个类: MainWindow, AddressWidget, TableModel, NewAddressTab and AddDialog.  MainWindow class u使用 AddressWidget 作为它的中心部件并且提供文件和工具菜单</p>
<p>这一篇主要讲讲代理模型QSortFilterProxyModel，<br>QSortFilterProxyModel就是插入在model与view之间，起到<strong>对模型中的数据进行排序或者过滤，然后提供给视图进行显示</strong>的作用。<br>AddressWidget中有这样个函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> AddressWidget::setupTabs()</div><div class="line">&#123;</div><div class="line">    QStringList groups;</div><div class="line">    groups &lt;&lt; <span class="string">"ABC"</span> &lt;&lt; <span class="string">"DEF"</span> &lt;&lt; <span class="string">"GHI"</span> &lt;&lt; <span class="string">"JKL"</span> &lt;&lt; <span class="string">"MNO"</span> &lt;&lt; <span class="string">"PQR"</span> &lt;&lt; <span class="string">"STU"</span> &lt;&lt; <span class="string">"VW"</span> &lt;&lt; <span class="string">"XYZ"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; groups.size(); ++i) &#123;</div><div class="line">        QString str = groups.at(i);</div><div class="line">        QString regExp = QString(<span class="string">"^[%1].*"</span>).arg(str);<span class="comment">//这里是匹配以str中存储的三个字母中任意一个开头的字符串，如果没有这个规则，则ABC里也会显示以X开头的</span></div><div class="line"></div><div class="line">        proxyModel = <span class="keyword">new</span> QSortFilterProxyModel(<span class="keyword">this</span>);</div><div class="line">        proxyModel-&gt;setSourceModel(table);<span class="comment">//插入</span></div><div class="line">        proxyModel-&gt;setFilterRegExp(QRegExp(regExp, Qt::CaseInsensitive));<span class="comment">//设置过滤规则并大小写敏感</span></div><div class="line">        proxyModel-&gt;setFilterKeyColumn(<span class="number">0</span>);<span class="comment">//以第0列过滤</span></div><div class="line"></div><div class="line">        QTableView *tableView = <span class="keyword">new</span> QTableView;</div><div class="line">        tableView-&gt;setModel(proxyModel);<span class="comment">//插入</span></div><div class="line"></div><div class="line">        tableView-&gt;setSelectionBehavior(QAbstractItemView::SelectRows);</div><div class="line">        tableView-&gt;horizontalHeader()-&gt;setStretchLastSection(<span class="literal">true</span>);</div><div class="line">        tableView-&gt;verticalHeader()-&gt;hide();</div><div class="line">        tableView-&gt;setEditTriggers(QAbstractItemView::NoEditTriggers);</div><div class="line">        tableView-&gt;setSelectionMode(QAbstractItemView::SingleSelection);</div><div class="line"></div><div class="line">        tableView-&gt;setSortingEnabled(<span class="literal">true</span>);</div><div class="line"></div><div class="line">        connect(tableView-&gt;selectionModel(),</div><div class="line">            &amp;QItemSelectionModel::selectionChanged,</div><div class="line">            <span class="keyword">this</span>, &amp;AddressWidget::selectionChanged);</div><div class="line"></div><div class="line">        addTab(tableView, str);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/西门子FETCH-WRITE service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/西门子FETCH-WRITE service/" itemprop="url">西门子FETCH/WRITE service</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:10+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工控-pvbrowser/" itemprop="url" rel="index">
                    <span itemprop="name">工控 pvbrowser</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#西门子FETCH/WRITE service</p>
<hr>
<pre><code>slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0
</code></pre><p>在pvbrowser里设置与PLC连接的时候有一项fetch_write，下面具体看一下这一项</p>
<p>##rlSiemensTcp源码</p>
<pre><code>446   if((plc_type == S5 || plc_type == S7_300 || plc_type == S7_400) &amp;&amp; fetch_write == 1)
 447   {
 448     length = sizeof(ih) + sizeof(fh);
 449     ih.version  = 3;
 450     ih.reserved = 0;
 451     ih.length_high = length / 256;
 452     ih.length_low  = length &amp; 0x0ff;
 453     fh.ident[0]        = &apos;S&apos;;
 454     fh.ident[1]        = &apos;5&apos;;
 455     fh.header_len      = 16;
 456     fh.ident_op_code   = 1;
 457     fh.op_code_len     = 3;
 458     fh.op_code         = 5;
 459     fh.ident_org_block = 3;
 460     fh.len_org_block   = 8;
 461     fh.org_block       = (unsigned char) org;
 462     fh.dbnr            = (unsigned char) dbnr;
 463     fh.start_adr[0]    = (unsigned char) start_adr / 256;
 464     fh.start_adr[1]    = (unsigned char) start_adr &amp; 0x0ff;;
 465     fh.len[0]          = (unsigned char) len / 256;
 466     fh.len[1]          = (unsigned char) len &amp; 0x0ff;;
 467     fh.spare1          = 0x0ff;
 468     fh.spare1_len      = 2;
 469     unsigned char total_buf[sizeof(ih)+sizeof(fh)];
 470     memcpy(total_buf,             &amp;ih, sizeof(ih));
 471     memcpy(total_buf+sizeof(ih),  &amp;fh, sizeof(fh));
 472     ret = rlSocket::write(total_buf,   sizeof(ih)+sizeof(fh));
 473     rlDebugPrintf(&quot;fetch write ih ret=%d\n&quot;,ret);
 474     if(ret &lt; 0) return ret;  
 475     /*
 476     ret = rlSocket::write(&amp;ih,sizeof(ih));
 477     rlDebugPrintf(&quot;fetch write ih ret=%d\n&quot;,ret);
 478     if(ret &lt; 0) return ret;  
 479     ret = rlSocket::write(&amp;fh,sizeof(fh));
 480     rlDebugPrintf(&quot;fetch write fh ret=%d\n&quot;,ret);
 481     if(ret &lt; 0) return ret;
 482     */
 483     ret = rlSocket::read(&amp;ih,sizeof(ih),TIMEOUT);
 484     rlDebugPrintf(&quot;fetch read ih ret=%d\n&quot;,ret);
 485     if(ret &lt;= 0) return ret;
 486     ret = rlSocket::read(&amp;fa,sizeof(fa),TIMEOUT);
 487     rlDebugPrintf(&quot;fetch read fa ret=%d\n&quot;,ret);
 488     if(ret &lt;= 0) return ret;
 489     if(fa.error_block != 0) return -1;
 490     ret = rlSocket::read(buf,len_byte,TIMEOUT);
 491     rlDebugPrintf(&quot;fetch read buf ret=%d\n&quot;,ret);
 492     if(ret &lt;= 0) return ret;
 493   }
</code></pre><p>###判断PLC系列</p>
<pre><code>if((plc_type == S5 || plc_type == S7_300 || plc_type == S7_400) &amp;&amp; fetch_write == 1)
</code></pre><p>首先判断PLC是不是S5，300和400系列。Fetch/Write只支持这些系列，对于像1200，200smart这些是不支持的。<br>并且，在300和400系列中，对于CP343-1，CP443-1是支持Fetch/Write的，对于内嵌Ethernet的CPU需要配置一下。如何配置请查看西门子官方文档《FETCH/WRITE service in an S7-300/400 CPU via the integrated Ethernet interface》.<br>如果不是这些系列的PLC或者fetch_write=0时，则是S7通讯.</p>
<blockquote>
<p>In today’s automation technology old systems are upgraded step by step from SIMATIC S5 to SIMATIC S7. However, the interfaces for the data exchange on the peer (for example, existing HMI systems) are to be kept. The FETCH/WRITE service is still very frequently used for the communication via Industrial Ethernet. The communication processors (CP343-1/CP443-1) of SIMATIC S7 support the services FETCH and WRITE for data exchange on the following protocols:</p>
<ul>
<li>TCP </li>
<li>ISO-on-TCP </li>
<li>ISO transport </li>
</ul>
<p>However, CPUs with integrated Industrial Ethernet interface are increasingly used in S7-300 and S7-400 stations to connect these to the Industrial Ethernet network and to exchange data with other nodes in the network. The FETCH/WRITE services have not been implemented here.</p>
<p>The SIMATIC S7 supports the FETCH and WRITE services only passive via the TCP native and ISO-on-TCP protocol. Furthermore, the SIMATIC S7 CPUs with integrated Industrial Ethernet interface do not support the S5 compatible communication.</p>
</blockquote>
<p>###Structure FETCH/WRITE Header telegram<br> rlSiemensTcp有四个结构体WH,WA,IH,IA</p>
<pre><code>182   typedef struct
183   {
184     unsigned char ident[2];
185     unsigned char header_len;
186     unsigned char ident_op_code;
187     unsigned char op_code_len;
188     unsigned char op_code;
189     unsigned char ident_org_block;
190     unsigned char len_org_block;
191     unsigned char org_block;
192     unsigned char dbnr;
193     unsigned char start_adr[2];
194     unsigned char len[2];
195     unsigned char spare1;
196     unsigned char spare1_len;
197   }WH; // write header
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/WH.PNG" alt="Write Header"></p>
<pre><code>198   typedef struct
199   {
200     unsigned char ident[2];
201     unsigned char header_len;
202     unsigned char ident_op_code;
203     unsigned char op_code_len;
204     unsigned char op_code;
205     unsigned char ack_block;
206     unsigned char ack_block_len;
207     unsigned char error_block;
208     unsigned char spare1;
209     unsigned char spare1_len;
210     unsigned char spare2[5];
211   }WA; // write ack
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/WA.PNG" alt="Write Ack"></p>
<pre><code>212   typedef struct
213   {
214     unsigned char ident[2];
215     unsigned char header_len;
216     unsigned char ident_op_code;
217     unsigned char op_code_len;
218     unsigned char op_code;
219     unsigned char ident_org_block;
220     unsigned char len_org_block;
221     unsigned char org_block;
222     unsigned char dbnr;
223     unsigned char start_adr[2];
224     unsigned char len[2];
225     unsigned char spare1;
226     unsigned char spare1_len;
227   }FH; // fetch header
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/FH.PNG" alt="Fetch Header"></p>
<pre><code>453     fh.ident[0]        = &apos;S&apos;;
454     fh.ident[1]        = &apos;5&apos;;
455     fh.header_len      = 16;
456     fh.ident_op_code   = 1;
457     fh.op_code_len     = 3;
458     fh.op_code         = 5;
459     fh.ident_org_block = 3;
460     fh.len_org_block   = 8;
461     fh.org_block       = (unsigned char) org;
462     fh.dbnr            = (unsigned char) dbnr;
463     fh.start_adr[0]    = (unsigned char) start_adr / 256;
464     fh.start_adr[1]    = (unsigned char) start_adr &amp; 0x0ff;;
465     fh.len[0]          = (unsigned char) len / 256;
466     fh.len[1]          = (unsigned char) len &amp; 0x0ff;;
467     fh.spare1          = 0x0ff;
468     fh.spare1_len      = 2;
</code></pre><p>这是rlSiemensTcp::fetch的部分内容，符合上图，这里构造好报头以后就可以通过Socket通讯连接了.</p>
<pre><code>228   typedef struct
229   {
230     unsigned char ident[2];
231     unsigned char header_len;
232     unsigned char ident_op_code;
233     unsigned char op_code_len;
234     unsigned char op_code;
235     unsigned char ack_block;
236     unsigned char ack_block_len;
237     unsigned char error_block;
238     unsigned char spare1;
239     unsigned char spare1_len;
240     unsigned char spare2[5];
241   }FA; // fetch ack
</code></pre><p><img src="http://oxehqp0gf.bkt.clouddn.com/FA.PNG" alt="Fetch Ack"></p>
<p>##Principle of the communication services FETCH and WRITE</p>
<blockquote>
<p>The FETCH and WRITE services are used for the data exchange by means of the following protocols:</p>
<ul>
<li>TCP  </li>
<li>ISO-on-TCP (TCP with RFC1006)  </li>
<li>ISO Transport protocol</li>
</ul>
<p>The SIMATIC S7 CPUs with integrated Industrial Ethernet interface do not support the ISO transport protocol. Here the FETCH and WRITE services for the data exchange are only supported via TCP and ISO-on-TCP protocol.</p>
</blockquote>
<p><img src="http://oxehqp0gf.bkt.clouddn.com/FetchWrite%20ISO.PNG" alt="Fetch/WriteのISO/OSI"></p>
<p>###Fetch</p>
<blockquote>
<p>The FETCH/WRITE client actively establishes the communication<br>connection. It requests the data from the FETCH/WRITE server by means of a FETCH request. The server responds with a positive acknowledgement of the FETCH request and sends the requested data. Otherwise, the acknowledgement of the FETCH response is negative.</p>
</blockquote>
<p>###Write</p>
<p>​    </p>
<blockquote>
<p>The FETCH/WRITE client sends a WRITE request with the data required in the FETCH/WRITE server. If the data has been successfully transmitted, the FETCH/WRITE server responds with a positive acknowledgement. Otherwise, the acknowledgement of the WRITE request is negative.</p>
</blockquote>
<p>###Summary<br><img src="http://oxehqp0gf.bkt.clouddn.com/FW%20Message%20structure.PNG" alt="FETCH/WRITE message structure"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/汇编程序的编译与连接/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/汇编程序的编译与连接/" itemprop="url">汇编程序的编译与连接</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:10+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#汇编程序的编译与连接</p>
<hr>
<p><strong>本文摘自《汇编语言》，作者王爽</strong></p>
<p>汇编程序写好后，使用汇编语言编译程序对源程序文件中的源程序进行编译，产生目标文件；再用连接程序对目标文件进行连接，生产可在操作系统中直接运行的可执行文件。<br>可执行文件包含两部分：</p>
<blockquote>
<ol>
<li>程序（从源程序汇编语言中翻译过来的机器码）和数据（源程序中定义的数据）</li>
<li>相关的描述信息（比如，程序有多大，要占用多少内存等）。操作系统依据可执行文件的相关描述信息，将可执行文件中的机器码和数据加载入内存，并进行相关初始化（比如设置CS:IP指向第一条要执行的指令），然后由CPU执行程序。</li>
</ol>
</blockquote>
<p>##编译<br>在编译过程中，我们提供一个输入，即源程序文件。最多可以得到三个输出：目标文件（.obj）,列表文件(.lst),交叉引用文件(.crf)。这三个文件中，交叉引用文件是我们最终要得到的结果，而另外两个只是中间结果，可以让编译器忽略对它们的生成。</p>
<p>##连接<br>这里只简单的说一下连接的几个作用。</p>
<ol>
<li>当源程序很大时，可以将它分为几个源程序文件来编译，每个源程序编译成为目标文件后，再用连接程序将他们连接到一起，生成一个可执行文件；</li>
<li>程序中调用来某个库文件中的子程序，需要将这个库文件和该程序生成的目标文件连接到一起，生成一个可执行文件；</li>
<li>一个源程序编译后，得到了存有机器码的目标文件，目标文件中的有些内容还不能直接用来生成可执行文件，连接程序将这些内容处理为最终的可执行信息。所以，在只有一个源程序文件，而又不需要调用某个库中的子程序的情况下，也必须用连接程序对目标文件进行处理，生成可执行文件。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/寄存器（内存访问）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/寄存器（内存访问）/" itemprop="url">寄存器（内存访问）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:10+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#寄存器（内存访问）</p>
<hr>
<p><strong>本文摘自《汇编语言》，作者王爽</strong></p>
<p>##DS和[address]<br>8086CPU中有一个DS寄存器,通常用来存放要访问数据的段地址。</p>
<blockquote>
<p>move al,[0]</p>
</blockquote>
<p>这里使用move指令将一个内存单元中的内容送入一个寄存器。[0]表示内存单元的偏移地址。只有偏移地址是不能定位一个内存单元的，那么内存的段地址是多少呢？指令执行时，CPU自动取ds中的数据为内存单元的段地址。<br>有一点需要注意的是，8086CPU不支持直接将数据送到段寄存器。所以<strong><em>move ds,1000H</em></strong>这条指令是非法的。应该这样：</p>
<blockquote>
<p>move bx,1000H<br>move ds,bx</p>
</blockquote>
<p>至于为什么8086CPU不支持直接将数据送到段寄存器?这属于8086CPU硬件设计的问题，只需要知道这一点就够了。</p>
<p>##move,add,sub指令总结</p>
<blockquote>
<p>move 寄存器,数据<br>move 寄存器,寄存器<br>move 寄存器,内存单元<br>move 内存单元,寄存器<br>move 段寄存器,寄存器<br>move 寄存器,段寄存器<br>move 内存单元,段寄存器<br>move 段寄存器，内存单元</p>
</blockquote>
<p>add与sub指令与move一样，只是不能对段寄存器进行操作。因为段寄存器不能像通用寄存器那样进行运算，这是硬件限制。而move指令不涉及运算，只是传送指令。</p>
<p>##栈<br>8086CPU的push和pop都是以字为单位进行的。</p>
<p>###两个问题</p>
<p>例如，我们可以把10000H-1000FH这段内存当做栈使用，但是至少有两个问题。</p>
<ol>
<li>CPU如何知道10000H-1000FH这段空间被当做栈使用？</li>
<li>在进行push，pop操作的时候，必须知道栈顶单元，可是，如何知道？</li>
</ol>
<blockquote>
<p>8086CPU中，有两个寄存器，段寄存器SS和寄存器SP。栈顶地址存放在SS中，偏移地址存放在SP中。任意时刻，SS:SP指向栈顶元素。</p>
</blockquote>
<p>###push与pop功能描述<br>这样，我们就可以完整的描述push和pop的功能了，如<strong><em>push ax</em></strong></p>
<blockquote>
<ol>
<li>SP=SP-2，SS:SP指向当前栈顶前面的单元，以当前栈顶前面的单元为新的栈顶。</li>
<li>将ax中的内容送入SS:SP指向内存单元处，SS:SP指向新栈顶。</li>
</ol>
</blockquote>
<p>pop执行过程与push刚好相反，<strong><em>pop ax</em></strong></p>
<blockquote>
<ol>
<li>将SS:SP指向的内存单元处的数据送入ax</li>
<li>SP=SP+2，SS:SP指向当前栈顶下面的单元，以当前栈顶下面的单元为新的栈顶。</li>
</ol>
</blockquote>
<p>push和pop都可以操作寄存器，段寄存器和内存单元。</p>
<blockquote>
<p>push 寄存器<br>push 段寄存器<br>push 内存单元</p>
</blockquote>
<p>###栈顶超界<br>8086帮助我们解决栈顶超界问题，自己使用时注意。既要防止入栈太多导致超界，也要防止栈空的时候出栈导致的超界。</p>
<p>###栈为什么逆向生长<br><strong><em>这段内容摘自《Reverse Engineering for Beginners》，作者：Dennis Yurichev</em></strong></p>
<p>The reason that the stack grows backward is probably historical. When the computers were big and occupied a whole room, it was easy to divide memory into two parts, one for the heap and one for the stack. Of course, it was unknown how big the heap and the stack would be during program execution, sothis solution was the simplest possible.<br>In [D. M. Ritchie and K. Thompson, The UNIX Time Sharing System, (1974)]we can read：</p>
<blockquote>
<p>The user-core part of an image is divided into three logical segments.<br>The program text segment begins at location 0 in the virtual address<br>space. During execution, this segment is write-protected and a single<br>copy of it is shared among all processes executing the same program.<br>At the first 8K byte boundary above the program text segment in the<br>virtual address space begins a nonshared, writable data segment, the<br>size of which may be extended by a system call. Starting at the<br>highest address in the virtual address space is a stack segment, which<br>automatically grows downward as the hardware’s stack pointer<br>fluctuates.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/《C++ Primer Plus》(第六版)笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/《C++ Primer Plus》(第六版)笔记/" itemprop="url">《C++ Primer Plus》(第六版)笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:09+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#《C++ Primer Plus》(第六版)笔记#</p>
<p>##1 什么时候应调用析构函数呢？##<br>这由编译器决定，通常不应在代码中显式的调用析构函数（有例外）。<br>如果创建的是静态储存类对象，则其析构函数将在程序结束时自动被调用。如果创建的是自动存储类对象，则其析构函数将在程序执行完代码块时（该对象在其中定义的）自动被调用。如果对象是通过new创建的，则它将驻留在栈内存或自由存储区中，当使用delete来释放内存时，其析构函数将自动被调用。最后程序可以创建临时对象来完成特定的操作，在这种情况下，程序将在结束对该对象的使用时自动调用其析构函数。</p>
<p>##2 三种链接性##<br>外部链接性（可在其他文件中访问）<br>内部链接性（只能在当前文件中访问）<br>无链接性（只能在当前函数或代码块中访问）<br>创建链接性为外部的静态持续变量，必须在代码块的外面声明它；<br>创建链接性为内部的静态持续变量，必须在代码块的外面声明它，并使用static限定符；<br>要创建没有链接性的静态持续变量，必须在代码块内声明它，并使用static限定符。</p>
<p>##3 单定义规则##<br>一方面，在每个使用外部变量的文件中，都必须声明它；另一方面，C++有“单定义规则”（One Definition Rule,ODR）,该规则指出，变量只能有一次定义。为满足这种需求，C++提供了两种变量声明。一种是定义声明（defining declaration）或简称定义（definition），它给变量分配存储空间；另一种是引用声明（referencing declaration）或简称声明（declaration），它不给变量分配存储空间，因为它引用已有变量。<br>引用声明使用关键字extern，<strong>且不进行初始化</strong>，否则，声明为定义，导致分配存储空间：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">double</span> up;  <span class="comment">//definition ,up is 0</span></div><div class="line"><span class="keyword">extern</span> <span class="keyword">int</span> blem;<span class="comment">// blem defined elsewhere</span></div><div class="line"><span class="keyword">extern</span> <span class="keyword">char</span> gr=<span class="string">'Z'</span>;<span class="comment">//definition because initializ</span></div></pre></td></tr></table></figure>
<p>单定义规则并不意味着不能有多个变量的名称相同。然而虽然程序中可包含多个同名的变量，但每个变量都只有一个定义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//file01.cpp</div><div class="line">	extern int cats=20;//definition because of initialzation</div><div class="line">	int dogs=22;//also a definition</div><div class="line">	int fleas;//also a definition</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//file02.cpp</div><div class="line">//use cats and dogs from file01.cpp</div><div class="line">	extern int cats;//not definitions because of they use</div><div class="line">	extern int dogs;//extern and have no initialization</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//file03.cpp</div><div class="line">//use cats,dogs,and fleas from file01.cpp</div><div class="line">	extern int cats;</div><div class="line">	extern int dogs;</div><div class="line">	extern int fleas;</div></pre></td></tr></table></figure>
<p>上面file02中没有重新声明变量fleas，因此无法访问它，在file01中，关键字extern并非必不可少，因为即使省略它，效果也相同。</p>
<p>##再谈const##<br>在C++（但不是C语言中），const限定符，对默认存储类型稍有影响。在默认情况下全局变量的链接性为外部的，但<strong>const全局变量的链接性为内部的</strong>.<br>因为这让程序员更加轻松。例如一组常量放在头文件中，并在同一个程序 的多个文件中使用该头文件。那么预处理器将头文件的内容包含到源文件后，所有源文件都将包含类似下面这样的定义:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">const int finger=10;</div><div class="line">const char* warning=&quot;walk!&quot;;</div></pre></td></tr></table></figure>
<p>如果全局const的链接性是外部，则根据单定义规则，这将出错。也就是说，只能有一个文件可以包含前面的声明，而其他文件必须使用extern关键字来提供引用声明。另外，只有未使用extern关键字的声明才能进行初始化:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//extern would be required if const had external linkage</div><div class="line">extern const int fingers;//can not be initialized</div><div class="line">extern const char* warning;</div></pre></td></tr></table></figure>
<p>因此，需要为某个文件使用一组定义，而其他文件使用另一组声明。然而，如果链接性为内部的，则可以在所有文件中使用相同的声明。</p>
<p>如果处于某种原因，希望某个常量链接性为外部的，则可以使用extern关键字如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">extern const int states=50;//definition with external linkage</div></pre></td></tr></table></figure>
<p>在种情况下，必须在所有使用该常量的文件中使用extern关键字来声明它。然而，鉴于单个const在多个文件之间共享，因此只有一个文件可对其进行初始化。<br>在函数或代码块中声明const时，其作用域为代码块，即仅当程序执行该代码块中的代码时，该常量才是可用的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/《C++ Primer Plus》(第六版)笔记二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/《C++ Primer Plus》(第六版)笔记二/" itemprop="url">《C++ Primer Plus》(第六版)笔记二</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:09+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#《C++ Primer Plus》(第六版)笔记二#</p>
<p>##1.继承中的构造函数##<br>派生类不能直接访问基类的私有成员，而必须通过基类的方法进行访问。因此，<strong>派生类构造函数必须使用基类构造函数</strong><br>RatedPlayer类继承自TableTennisPlayer</p>
<p>###通常情况###<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RatedPlayer::Ratedplayer(<span class="keyword">unsigned</span> <span class="keyword">int</span> r,<span class="keyword">const</span> <span class="built_in">string</span> &amp;fn,</div><div class="line"><span class="keyword">const</span> <span class="built_in">string</span> &amp;n,<span class="keyword">bool</span> ht):TableTennisPlayer(fn,ln,ht)</div><div class="line">&#123;</div><div class="line">	rating=r;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###省略成员初始化列表###</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RatedPlayer::Ratedplayer(unsigned int r,const string &amp;fn,</div><div class="line">const string &amp;n,bool ht)//what if no initializer list?</div><div class="line">&#123;</div><div class="line">	rating=r;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>必须首先创建基类对象，<strong>如果不调用基类构造函数，程序将使用默认的基类构造函数</strong>，因此上述代码与下面的等效:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RatedPlayer::Ratedplayer(unsigned int r,const string &amp;fn,</div><div class="line">const string &amp;n,bool ht)//：TableTennisPlayer()</div><div class="line">&#123;</div><div class="line">	rating=r;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除非要使用默认构造函数，否则应显式地调用正确的基类函数.</p>
<p>###第三种情况###</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RatedPlayer::Ratedplayer(unsigned int r,const TableTennisPlayer &amp; tp)：TableTennisPlayer(tp)</div><div class="line">&#123;</div><div class="line">	rating=r;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于tp 的类型为TableTennisPlayer &amp; ，因此将调用基类复制构造函数。<br>也可以对派生类成员初始化列表语法，在这种情况下，应该在列表中使用成员名，而不是类名</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RatedPlayer::Ratedplayer(<span class="keyword">unsigned</span> <span class="keyword">int</span> r,<span class="keyword">const</span> TableTennisPlayer &amp; tp)：TableTennisPlayer(tp),rating(r)</div><div class="line">&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###小结###</p>
<ul>
<li>首先创建基类对象</li>
<li>派生类构造函数应通过成员初始化列表将基类信息传递给基类构造函数</li>
<li>派生类构造函数应初始化派生类新增的数据成员</li>
<li><p>释放对象的顺序与创建对象的顺序相反，即先执行派生类的析构函数，然后自动调用基类的析构函数</p>
<p>##2.派生类与基类的特殊关系##</p>
</li>
</ul>
<ul>
<li>派生类对象可以使用基类的方法，条件是方法不是私有的 </li>
<li>基类指针可以在不进行显式类型转换的情况下指向派生类对象，反之不行<pre><code>基类引用可以在不进行显式类型转换的情况下指向派生类对象，反之不行
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RatedPlayer rplayer(1140,&quot;Mallory&quot;,&quot;Duck&quot;,true);</div><div class="line">TableTennisPlayer &amp;rt=rplayer;</div><div class="line">TableTennisPlayer *pt=&amp;rplayer;</div><div class="line">rt.name();//invoke name() with reference</div><div class="line">pt-&gt;name();//invoke name() with pointer</div></pre></td></tr></table></figure>
</li>
</ul>
<p>基类引用或指针只能用于调用基类方法，因此，不能使用rt或pt调用派生类RestRanking方法.</p>
<p>###虚函数###<br>使用virtual时，如果方法是通过引用或指针而不是对象调用的，它将确定使用哪一种方法，如下<br><strong>如果没有使用关键字virtual，程序将根据引用类型或指针类型选择方法，如果使用了virtual，程序将根据引用或指针指向的对象来选择方法.</strong><br><strong>方法在基类中被声明为虚的后，它在派生类中将自动成为虚方法</strong></p>
<p>##3.赋值运算符##<br>不要将赋值与初始化混淆了，如果语句创建新的对象，则使用初始化，如果语句修改已有对象的值，则是赋值:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Star sirius;</div><div class="line">Star alpha=sirius;//initialization(one notation)</div><div class="line">Star dogstar;</div><div class="line">dogstar =sirius;//assigment</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/pvbrowser如何通过Siemens tcp连接PLC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/pvbrowser如何通过Siemens tcp连接PLC/" itemprop="url">pvbrowser如何通过Siemens tcp连接PLC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:09+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工控-pvbrowser/" itemprop="url" rel="index">
                    <span itemprop="name">工控 pvbrowser</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pvbrowser如何通过Siemens-tcp连接PLC"><a href="#pvbrowser如何通过Siemens-tcp连接PLC" class="headerlink" title="pvbrowser如何通过Siemens tcp连接PLC"></a>pvbrowser如何通过Siemens tcp连接PLC</h1><hr>
<p>pvbrowser是一款德国的基于Qt的开源组态软件。尽管市场中用的很少，我们还是可以通过看其源码学习很多东西。</p>
<p>pvbrowser里有两种方式通过Simens tcp与PLC通讯:Daemon与pvbaddon.</p>
<p>##Daemon</p>
<p>###通过Daemon生成EXE文件<br>打开pvdevelop，选择<em>菜单栏-&gt;daemon-&gt;Siemens Tcp</em></p>
<pre><code>shared_memory=C:\\automation\\shm\\siemens.shm
mailbox=C:\\automation\\mbx\\siemens.mbx
# type := S7_200 | S7_300 | S7_400 | S5 | S7_1200 | LOGO
slave=0 adr=192.168.1.99 type=S7_1200 fetch_write=0 function=1 rack_slot=0
idletime=50 milliseconds
#eventlog host=localhost port=6000
# ORG := ORG_DB | ORG_M | ORG_E | ORG_A | ORG_PEPA | ORG_Z | ORG_T
# cycle := slave + org + dbnum + start + len
cycle1 slave=0 org=ORG_E  dbnum=0 start=0 len=1
cycle2 slave=0 org=ORG_A  dbnum=0 start=0 len=1
</code></pre><p>这里面有以下几个需要注意的点:</p>
<ol>
<li>shared memory和mailbox的文件路径是需要自己建的，这个软件不会给你建。<br>Note that these directories must be created first by you. Note that the size of the shared memory must be equal in the daemon and in the pvserver.<br>2.关于 fetch_write的设定<br>fetch_write=1为fetch/write服务,fetch_write=0为S7连接。<br>(1) There is the old Fetch/Write protocol from the old S5 PLC<br>(fetch_write=1).Fetch/Write只支持S5和300，400系列.<br>(2) And there is the current Siemens PLC protocol introduced with the S7 series of PLC (fetch_write=0).</li>
<li>FUNCTION    := optional parameter for PLC (1=PG,2=OP,3=Step7Basic)<br>经验证123均可连通。</li>
<li>经验证，rack_slot这个值设随机值都能通</li>
<li>ORG_E指的是Eingang(输入)，ORG_A指的是Ausgang(输出)，ORG_M是Merker(这个单词没查到，经验证是M区)，ORG_DB是Datenbaustein(DB区).此外还有ORG_PEPA指的是Peripheral(外围设备) Area R/W ，ORG_Z意思是Zaehler(计数器),ORG_T意思是Timer(计时器)<br>设置好以后点compile，然后点close.<br>这时，项目文件夹下会生成siemensdaemon.cpp,siemensdaemon.h,siemensdaemon.exe和siemensdaemon.mksimens四个文件<br>运行siemensdaemon.exe文件，数据就从PLC里面读取到共享内存里了(可能会遇到缺少*.dll文件，在pvbrowser安装目录里找到对应的文件放进项目文件即可)。<br>###如何进行调试<br>当我们遇到连接不通的时候怎么办呢，因为是pvbrowser是基于Qt的，我们可以通过Qt对其进行调试。</li>
<li>新建空Qt控制台项目，添加Deamon生成的siemensdaemon.h和siemensdaemon.cpp文件。并将缺少的头文件放到目录里，这些头文件可以在pvb安装目录底下找到。</li>
<li><p>在该项目的makefile里添加</p>
<p> win32-g++ {<br> QMAKE_LFLAGS      += -static-libgcc<br> win32:LIBS        += $(PVBDIR)/win-mingw/bin/libserverlib.a<br> win32:LIBS        += $(PVBDIR)/win-mingw/bin/librllib.a<br> win32:LIBS        += -lws2_32 -ladvapi32 -lpthread<br> win32:INCLUDEPATH += $(PVBDIR)/pvserver<br> win32:INCLUDEPATH += $(PVBDIR)/rllib/lib<br> }</p>
</li>
</ol>
<p>这样项目就建好了，可以进行更改调试。</p>
<p>##pvbaddon<br>可以在pvbrowser下载pvbaddon<br>在pvbaddon\pvbaddon\daemons\siemenstcp\client\release目录下有siemenstcp_client.exe 文件，需要配合ini文件使用。<br>example.ini</p>
<pre><code># ini file for siemenstcp_client
#
# DEBUG       := 1 | 0
# SLAVE&lt;N&gt;    := IP,PLC_TYPE,FETCH_WRITE,FUNCTION,RACK_SLOT
# PLC_TYPE    := ANY | S7_200 | S7_300 | S7_400 | S5 | S7_1200 | LOGO
# FETCH_WRITE := 1 | 0 # default 1
# FUNCTION    := optional parameter for PLC (1=PG,2=OP,3=Step7Basic)
# RACK_SLOT   := optional parameter for PLC  Byte(upper_3_bit_is_rack / lower_5_bit_is_slot)
# CYCLE&lt;N&gt;    := &lt;count&gt;,&lt;name&gt;
# name        := byte&lt;ORG&gt;(slave,dbnum,adr)   | 
#                float&lt;ORG&gt;(slave,dbnum,adr)  |
#                dword&lt;ORG&gt;(slave,dbnum,adr)  |
#                short&lt;ORG&gt;(slave,dbnum,adr)  |
#                udword&lt;ORG&gt;(slave,dbnum,adr) |
#                ushort&lt;ORG&gt;(slave,dbnum,adr)
# ORG         := ORG_DB | ORG_M | ORG_E | ORG_A | ORG_PEPA | ORG_Z | ORG_T
# HAVETO_SWAP := 1 | 0 # must be 1 on intel machines
# CYCLETIME in milliseconds
# SHARED_MEMORY_SIZE must be equal to SHARED_MEMORY_SIZE of pvserver
# MAX_NAME_LENGTH is maximum length of variable name in shared memory 
#

[GLOBAL]
DEBUG=1
CYCLETIME=1000
HAVETO_SWAP=1

[SOCKET]
NUM_SLAVES=1
SLAVE1=192.168.1.101,ANY,0
#SLAVE2=192.168.1.35,S7_200,0,1,2

# You may also specify the TSAPs explicitly.
# In that case the PLC_TYPE does not care. Use ANY.
[SLAVE1_CONNECT_BLOCK]
#S7-200
CB13=&apos;M&apos; # remote TSAP        (not necessary to set explicitly)
CB14=&apos;W&apos; # remote TSAP        (not necessary to set explicitly)
CB17=&apos;M&apos; # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
CB18=&apos;W&apos; # local  TSAP slot 1 (upper_3_bit_is_rack / lower_5_bit_is_slot)
#S7-300
#CB13=2 # remote TSAP        (not necessary to set explicitly)
#CB14=1 # remote TSAP        (not necessary to set explicitly)
#CB17=1 # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
#CB18=2 # local  TSAP slot 2 (upper_3_bit_is_rack / lower_5_bit_is_slot)
#S7-400
#CB13=2 # remote TSAP        (not necessary to set explicitly)
#CB14=1 # remote TSAP        (not necessary to set explicitly)
#CB17=1 # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
#CB18=3 # local  TSAP slot 3 (upper_3_bit_is_rack / lower_5_bit_is_slot)
#S7-1200
#CB13=2 # remote TSAP        (not necessary to set explicitly)
#CB14=1 # remote TSAP        (not necessary to set explicitly)
#CB17=1 # local  TSAP PG     (1=PG,2=OP,3=Step7Basic)
#CB18=0 # local  TSAP slot 0 (upper_3_bit_is_rack / lower_5_bit_is_slot)

[RLLIB]
MAX_NAME_LENGTH=30
SHARED_MEMORY=/srv/automation/shm/siemenstcp1.shm
SHARED_MEMORY_SIZE=65536
MAILBOX=/srv/automation/mbx/siemenstcp1.mbx

[CYCLES]
NUM_CYCLES=4
CYCLE1=10,byteORG_M(1,0,0)
CYCLE2=4,byteORG_E(1,0,0)
CYCLE3=4,byteORG_A(1,0,0)
CYCLE4=4,byteORG_DB(1,1,0)
#CYCLE2=1,byteORG_M(2,2,3)
</code></pre><p>这里我没有做更改，更改的话与Deamon需要注意的地方相同。<br>打开cmd cd到该目录下运行</p>
<pre><code>siemenstcp_client.exe example.ini
</code></pre><p>数据就到mailbox里面了</p>
<p>调试的话，里面有Qt项目文件可以直接打开</p>
<p>这样PLC数据就读取到shared memory或mailbox里了，可以进行后期的上位编程。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/PLC基本知识（二）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/PLC基本知识（二）/" itemprop="url">PLC基本知识（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:09+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工控/" itemprop="url" rel="index">
                    <span itemprop="name">工控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>﻿##PLC基本知识（二）##</p>
<ul>
<li>RS232与RS485区别：RS485用双绞线传输，传的是差分信号，当A比B电压高时为“1”，低时为“0”，因此RS485抗干扰能力较强，通常能传输1000米以上，RS232至少3根线，一根是TxD，一根RxD，一根GND，传送时把TTL转换成+-12V电平。RS232传输距离较短，一般10米左右。因此RS485为半双工个，RS232为全双工。 还有RS485已经是网络技术了，一条总线上可以连接200多节点，而RS232只能在2点之间通信。485上跑，必然是主从模式。</li>
<li>三种时基的刷新方式（1ms，10ms，100ms）：简单的说，1ms的定时器采用中断方式刷新当前值，每隔1ms系统自动刷新一次定时器和当前位，与扫描周期无关；10ms的定时器，定时器位和当前值总是在每个扫描周期开始时被刷新，之后在整个扫描周期内不变；100ms的定时器，是在该指令被执行时刷新，是在扫描过程中读到该定时器时才对定时器接点和当前值进行更新；因此确保每个扫描周期内，程序仅为100ms的定时器执行一次指令，以便使定时器保持正确计时。</li>
<li>状态转移图或步进梯形图中输出继电器想多次使用，例如两个Q0.0，可以采用第一个Q0.0用立即输出线圈，后面一个用普通输出线圈。</li>
<li>S7-300有4种电源模块，其中PS305是直流供电，PS307是交流供电，电源模块与S7-300PLC的背板之间没有连接，可以隔离安装，CPU不能对电源进行诊断。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/24/QStandardItemModel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiao Maojin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JMJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/QStandardItemModel/" itemprop="url">QStandardItemModel</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-24T19:22:09+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index">
                    <span itemprop="name">Qt</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>﻿#QStandardItemModel#</p>
<p>以下内容摘自 《t中的C++技术》</p>
<p>##基本知识##<br>类QabstractItemModel，QabstractListModel，QAbstractTableModel不保存数据，用户需要从这些类派生出子类，并在子类中定义某种数据结构来保存数据。与此不同，类QStandardItemModel负责保存数据，每个数据项被表示为类QStandardItem的对象。<br><strong>QStandardItem用来保存一个数据项，再使用QStandardItemModel将这些数据项组织起来，形成列表、表格或者树，以供其他视图类显示。</strong><br>一个数据项由若干个『角色，数据子项』对组成。类QStandardItem负责保存、访问这些数据。该类的内部定义了一个类型为QVector的容器，每个容器元素本质上存放一个『角色，数据子项』对。<br>由于各个角色对应的数据子项可能具有不同的类型，Qt使用QVariant来存放每个数据子项。当用户希望将一些数据存放在一个QStandardItem对象中时，可以调用其成员函数：<br>void setData ( const QVariant &amp; value, int role)<br>将『role, value』对存入。<br>当用户希望读取该对象中的数据时，可以调用另外一个成员函数：</p>
<p>QVariant data ( int role = ) const</p>
<p>读取角色role对应的数据子项。</p>
<p>以上两个函数是QStandardItem的核心。<strong>有了这两个函数，我们就可以访问该类所表示数据项的任何一个『角色，数据子项』对。然而，对于一些常用角色，该类提供了更加简洁、容易记忆的成员函数。</strong>例如，当一个数据项被显示在视图中时，它往往包含一些文字、一个图标，还可能包含一个复选框。角色Qt::BackgroundRole控制显示背景，Qt::FontRole控制文字字体，Qt::ForegroundRole控制文字颜色，Qt::CheckStateRole控制复选框的状态。该类提供的一组成员函数可以方便地访问这些常用角色对应的数据子项。成员函数setBackground()、background()分别设置/返回背景刷子。函数setFont()、font()分别设置/返回文字字体。函数setForeground()、foreground()分别设置/返回字体颜色。函数setCheckState()、checkState()分别设置/返回复选框状态。</p>
<p>##如果数据集被表示为一个列表##<br>如果数据集被表示为一个列表，我们可以调用类QStandardItemModel的成员函数<strong>appendRow()</strong>向列表中添加一个数据项，使用<strong>item()</strong>读取一个数据项,代码如下:</p>
<figure class="highlight qt"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">QStandardItemModel listModel;</div><div class="line">QStandardItem *rootItem = listModel.invisibleRootItem(); <span class="comment">//获取模型最底层的根节点         </span></div><div class="line"><span class="keyword">for</span> (<span class="built_in">int</span> row = <span class="number">0</span>; row &lt; <span class="number">4</span>; ++row) &#123;</div><div class="line"> QStandardItem *item = <span class="keyword">new</span> QStandardItem(QString(<span class="string">"%0"</span>).arg(row) );<span class="comment">//表示一个数据项，构造函数在内部调用该类的setData()函数，将QString对象作为Qt::DisplayRole对应的数据子项存入新构造的对象</span></div><div class="line"> rootItem-&gt;appendRow( item );  <span class="comment">//将该数据项作为根节点的子节点添加到列表中。</span></div><div class="line">&#125; </div><div class="line">QListView listView;<span class="comment">//因为数据集本身是一个列表，所以使用QListView展示</span></div><div class="line">listView.setModel ( &amp; listModel );</div></pre></td></tr></table></figure>
<p><strong>QStandardItem(QString(“%0”).arg(row) );这句话的构造函数在内部调用该类的setData()函数，将QString对象作为Qt::DisplayRole对应的数据子项存入新构造的对象（终于找到哪调用的setData()函数了）</strong></p>
<p>##如果数据集被表示为一个表格##<br>如果数据集被表示为一个表格，可以调用类QStandardItemModel的成员函数<strong>setItem()</strong>设定表格中的某个数据项,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">QStandardItemModel tableModel(4, 4);</div><div class="line"> for (int row = 0; row &lt; 4; ++row) &#123;</div><div class="line">   for (int column = 0; column &lt; 4; ++column) &#123;</div><div class="line">    QStandardItem *item = new QStandardItem(</div><div class="line">     QString(&quot;%0,%1&quot;).arg(row).arg(column));</div><div class="line">    tableModel.setItem(row, column, item);</div><div class="line">   &#125;</div><div class="line"> &#125; </div><div class="line"> QTableView tableView;//因为数据集是个表格，所以使用QTableView</div><div class="line"> tableView.setModel( &amp; tableModel );</div></pre></td></tr></table></figure>
<p>##如果数据集被表示为一个树##<br>如果数据集被表示为一个树，可以调用类QStandardItemModel的成员函数appendRow()向某个树节点添加子节点。通过多次调用该函数，可以构建一棵复杂的树。代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">QStandardItemModel treeModel;</div><div class="line">QStandardItem *parentItem = treeModel.invisibleRootItem();</div><div class="line">for (int i = 0; i &lt; 4; ++i) &#123;</div><div class="line"> QStandardItem *item = new QStandardItem(QString(&quot;%0&quot;).arg(i));</div><div class="line"> parentItem-&gt;appendRow(item);</div><div class="line"> parentItem = item;</div><div class="line">&#125;</div><div class="line">QTreeView treeView;//由于数据集是一棵树，我们使用QTreeView显示它</div><div class="line">treeView.setModel( &amp; treeModel );</div></pre></td></tr></table></figure>
<p>##总结##<br>类QStandardItemModel之所以能够表示列表、表格、树甚至更复杂的数据结构，得益于类QStandardItem在其内部定义了一个类型为QVector<code>&lt;</code>QStandardItem*<code>&gt;</code>的容器，可以将每个容器元素所指的QStandardItem对象设定为子对象。表现在如下图所示的类图上，类QStandardItem和自身具有“children”关系。一个类和自身发生关联，在UML中被称为自关联（self association）。类QStandardItemModel定义了一个名为root的数据成员，逻辑上是一个指向QStandardItem对象的指针。这个对象可以设定多个QStandardItem的对象作为自己的子对象，而其中每个子对象又可以包含其他的子对象。依此类推，这棵树可以具有任意深度，每个父对象可以包含任意多个子对象。<img src="http://img.blog.csdn.net/20170721213157481?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnNuQWx0cmlh/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="类QStandardItem使用自关联以形成层次结构"><br>很自然地，QStandardItemModel可以使用QStandardItem表示具有树状数据结构的数据集，如图13 14所示。图中的每个小方框表示类QStandardItem的一个对象。如果小方框的边线为虚，相应的QStandardItem对象并不表示数据集中的任何数据，仅被用来表示某种数据结构。如果小方框的边线为实，相应的QStandardItem对象就表示数据集中的一个数据项。在右侧的图中，QStandardItemModel的数据成员root所指的对象表示一个不可见的根，而数据集的根（图中结点G）被表示为这个不可见根的一个子节点。<br><img src="http://img.blog.csdn.net/20170721213942624?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnNuQWx0cmlh/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="类QStandardItem使用自关联形成列表、表格与树"><br>列表被看作一个特殊的树：不可见根具有若干个子节点，每个子节点表示列表中的一个数据项，不再包含任何子节点，如该图左侧所示。而表格的表示方式反而麻烦一些。不可见根含有若干子节点（图中A，B，C），这些子节点并不表示数据集中的任何数据项。第i个子节点会包含若干子节点（比如图中D，E，F），这些子节点才表示表格第i行的数据项。</p>
<p>###优点###<br>使用QStandardItemModel表示数据集具有以下优点：该类使用QStandardItem存放数据项，用户不必定义任何数据结构来存放数据项；QStandardItem使用自关联关系，能够表达列表、表格、树甚至更复杂的数据结构，能够涵盖各种各样的数据集；QStandardItem本身存放着多个『角色，数据子项』，视图类、委托类或者其他用户定义的类能够方便地依据角色访问各个数据子项。</p>
<p>###缺点###<br>然而，这种表示方法也有局限性：当数据集中的数据项很多时，施加在数据集上的某些操作的执行效率会很低。比如，设数据集是一个1万行、20列的表格，其中第10列存放的是浮点数。如果我们想计算这一列的平均值，按照图13 14，这需要遍历所有行，取得第10列的QStandardItem对象，再依据角色“Qt::DisplayRole”取得对应的数据子项。由于这个数据子项的类型为QString，还需要将其转换为浮点数，最后求所有浮点数的平均值。这些操作会耗费较长的时间。</p>
<p>###结论###<br>因此，对于数据量不是很大、对性能要求不是很高的场合，我们可以使用类QStandardItemModel来表示一个数据集。否则，用户应该从QAbstractItemModel、QAbstractListModel或者QAbstractTableModel派生新类，自行管理数据集的存放与访问。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiao Maojin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiao Maojin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  

  

  

</body>
</html>
